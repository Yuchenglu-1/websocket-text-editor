<!DOCTYPE html>
<html xmlns:th="http://www.thymeleaf.org">
<head>
    <title>Online Users</title>
    <meta charset="utf-8">
    <meta name="viewport" content="width=device-width, initial-scale=1">
    <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.3/dist/css/bootstrap.min.css" rel="stylesheet">
    <link rel="stylesheet" th:href="@{/style.css}">
    <style>
        .user-card {
            transition: transform 0.2s;
        }
        .user-card:hover {
            transform: translateY(-2px);
            box-shadow: 0 4px 8px rgba(0,0,0,0.1);
        }
        .pagination-container {
            display: flex;
            justify-content: center;
            margin-top: 20px;
        }
        .online-indicator {
            width: 10px;
            height: 10px;
            border-radius: 50%;
            background-color: #4CAF50;
            display: inline-block;
            margin-right: 5px;
        }
        /* é€šçŸ¥é¢æ¿æ ·å¼ */
        .notification-panel {
            position: fixed;
            top: 70px;
            right: 20px;
            width: 350px;
            max-height: 500px;
            background-color: white;
            border: 1px solid #ddd;
            border-radius: 8px;
            box-shadow: 0 4px 12px rgba(0,0,0,0.15);
            z-index: 1000;
            display: none;
            flex-direction: column;
        }
        
        .notification-header {
            padding: 15px;
            border-bottom: 1px solid #eee;
            display: flex;
            justify-content: space-between;
            align-items: center;
        }
        
        .notifications-container {
            overflow-y: auto;
            max-height: 400px;
        }
        
        .notification-item {
            padding: 12px 15px;
            border-bottom: 1px solid #eee;
            cursor: pointer;
        }
        
        .notification-item:hover {
            background-color: #f8f9fa;
        }
        
        .notification-item.unread {
            background-color: #e9f7fe;
        }
        
        .notification-title {
            font-weight: bold;
            margin-bottom: 5px;
        }
        
        .notification-message {
            font-size: 0.9em;
            color: #666;
            margin-bottom: 5px;
        }
        
        .notification-time {
            font-size: 0.8em;
            color: #999;
        }
        
        .notification-badge {
            position: absolute;
            top: -8px;
            right: -8px;
            background-color: #dc3545;
            color: white;
            border-radius: 50%;
            padding: 2px 6px;
            font-size: 0.7em;
        }
    </style>
</head>
<body>
    <nav class="navbar navbar-expand-lg navbar-dark bg-dark">
        <div class="container-fluid">
            <a class="navbar-brand" href="/">ğŸ“ Code Share</a>
            <div class="navbar-nav ms-auto">
                <div class="nav-item dropdown">
                    <a class="nav-link dropdown-toggle d-flex align-items-center" href="#" id="navbarDropdown" role="button" data-bs-toggle="dropdown" aria-expanded="false">
                        <!-- å¦‚æœç”¨æˆ·æœ‰å¤´åƒåˆ™æ˜¾ç¤ºå¤´åƒï¼Œå¦åˆ™æ˜¾ç¤ºé»˜è®¤å¤´åƒ -->
                        <img th:if="${currentUser.avatarUrl}" th:src="${currentUser.avatarUrl}" alt="Avatar" class="rounded-circle me-2" width="32" height="32">
                        <img th:unless="${currentUser.avatarUrl}" src="data:image/svg+xml;base64,PHN2ZyB4bWxucz0iaHR0cDovL3d3dy53My5vcmcvMjAwMC9zdmciIHdpZHRoPSIxNiIgaGVpZ2h0PSIxNiIgZmlsbD0iY3VycmVudENvbG9yIiBjbGFzcz0iYmkgYmktcGVyc29uLWJyaWdleCIgdmlld0JveD0iMCAwIDE2IDE2Ij4KICA8cGF0aCBkPSJNOC41IDJBNi41IDYuNSAwIDEgMCA4IDE1YTUuMDAzIDUuMDAzIDAgMSAwIDAgMTBhNi41IDYuNSAwIDAgMCA2LjUtNi41djEuNWEzLjUgMy41IDAgMSAxLTctN3oiLz4KICA8Y2lyY2xlIGN4PSI4IiBjeT0iOCIgcj0iMyIvPgo8L3N2Zz4=" alt="Avatar" class="rounded-circle me-2" width="32" height="32">
                        <span th:text="${currentUser.username}">User</span>
                    </a>
                    <ul class="dropdown-menu dropdown-menu-end" aria-labelledby="navbarDropdown">
                        <li><a class="dropdown-item" href="/profile" id="profileLink">ğŸ‘¤ Profile</a></li>
                        <li><hr class="dropdown-divider"></li>
                        <li><a class="dropdown-item" href="#" id="logoutLink">ğŸšª Logout</a></li>
                    </ul>
                </div>
            </div>
        </div>
    </nav>

    <div class="container mt-4">
        <div class="d-flex justify-content-between align-items-center mb-4">
            <div class="d-flex align-items-center">
                <a href="javascript:void(0)" id="back-btn" class="btn btn-secondary me-3">â† è¿”å›</a>
                <h1>ğŸ‘¥ Online Users</h1>
            </div>
            <div class="d-flex align-items-center">
                <span class="badge bg-success me-2">
                    <span class="online-indicator"></span>
                    Online: <span id="online-count">0</span>
                </span>
                <button id="refresh-btn" class="btn btn-outline-primary btn-sm">
                    ğŸ”„ Refresh
                </button>
                <!-- æ¶ˆæ¯é€šçŸ¥æŒ‰é’® -->
                <div class="position-relative ms-2">
                    <button id="notification-btn" class="btn btn-sm btn-outline-primary position-relative">
                        <i class="fas fa-bell"></i> ğŸ””
                    </button>
                    <!-- é€šçŸ¥å¾½ç« ï¼Œæ˜¾ç¤ºæœªè¯»é€šçŸ¥æ•°é‡ -->
                    <span id="notification-badge" class="notification-badge" style="display: none;">0</span>
                </div>
            </div>
        </div>
        
        <!-- é€šçŸ¥é¢æ¿ -->
        <div id="notification-panel" class="notification-panel">
            <div class="notification-header">
                <h6>é€šçŸ¥</h6>
                <!-- æ¸…é™¤æ‰€æœ‰é€šçŸ¥æŒ‰é’® -->
                <button id="clear-notifications" class="btn btn-sm btn-outline-secondary">æ¸…é™¤</button>
            </div>
            <div id="notifications-container" class="notifications-container">
                <!-- é€šçŸ¥å†…å®¹å°†é€šè¿‡JavaScriptåŠ¨æ€æ·»åŠ  -->
            </div>
        </div>

        <div class="row" id="users-container">
            <!-- ç”¨æˆ·å¡ç‰‡å°†é€šè¿‡JavaScriptåŠ¨æ€åŠ è½½ -->
        </div>

        <div class="pagination-container">
            <nav>
                <ul class="pagination" id="pagination">
                    <!-- åˆ†é¡µæŒ‰é’®å°†é€šè¿‡JavaScriptåŠ¨æ€ç”Ÿæˆ -->
                </ul>
            </nav>
        </div>
    </div>

    <div id="toast-container"></div>

    <!-- æ·»åŠ SockJSå’ŒSTOMPåº“ -->
    <script src="https://cdn.jsdelivr.net/npm/sockjs-client@1/dist/sockjs.min.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/stompjs@2/lib/stomp.min.js"></script>
    <script src="/js/websocket-manager.js"></script>
    
    <script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.3/dist/js/bootstrap.bundle.min.js"></script>
    <script th:inline="javascript">
        /*<![CDATA[*/
        const currentUsername = /*[[${currentUser.username}]]*/ 'user';
        /*]]>*/
    </script>
    <script>
        let currentPage = 1;
        const pageSize = 10;
        let allUsers = [];
        let subscriptionId = null; // ç”¨äºå­˜å‚¨WebSocketè®¢é˜…ID
        let notificationCount = 0; // æœªè¯»é€šçŸ¥è®¡æ•°
        
        // é¡µé¢åŠ è½½æ—¶è·å–åœ¨çº¿ç”¨æˆ·
        document.addEventListener('DOMContentLoaded', function() {
            // é¡µé¢åŠ è½½å®Œæˆåç«‹å³åˆ·æ–°ä¸€æ¬¡åœ¨çº¿ç”¨æˆ·åˆ—è¡¨
            setTimeout(loadOnlineUsers, 100);
            
            // ç»‘å®šåˆ·æ–°æŒ‰é’®äº‹ä»¶
            document.getElementById('refresh-btn').addEventListener('click', loadOnlineUsers);
            
            // ç»‘å®šç™»å‡ºäº‹ä»¶
            document.getElementById('logoutLink').addEventListener('click', function(e) {
                e.preventDefault();
                performLogout();
            });
            
            // ç»‘å®šProfileé“¾æ¥äº‹ä»¶
            document.getElementById('profileLink').addEventListener('click', function(e) {
                e.preventDefault();
                window.location.href = '/profile';
            });
            
            // ç»‘å®šè¿”å›æŒ‰é’®äº‹ä»¶
            document.getElementById('back-btn').addEventListener('click', function() {
                // æ£€æŸ¥æ˜¯å¦æœ‰referrerï¼ˆæ¥æºé¡µé¢ï¼‰
                if (document.referrer) {
                    // å¦‚æœæœ‰æ¥æºé¡µé¢ï¼Œåˆ™è¿”å›æ¥æºé¡µé¢
                    window.history.back();
                } else {
                    // å¦‚æœæ²¡æœ‰æ¥æºé¡µé¢ï¼Œåˆ™è¿”å›åˆ°ä¸»é¡µ
                    window.location.href = '/';
                }
            });
            
            // ç»‘å®šé€šçŸ¥æŒ‰é’®äº‹ä»¶
            document.getElementById('notification-btn').addEventListener('click', function(e) {
                e.stopPropagation();
                toggleNotificationPanel();
            });
            
            // ç»‘å®šæ¸…é™¤é€šçŸ¥æŒ‰é’®äº‹ä»¶
            document.getElementById('clear-notifications').addEventListener('click', function() {
                clearNotifications();
            });
            
            // ç‚¹å‡»é¡µé¢å…¶ä»–åœ°æ–¹éšè—é€šçŸ¥é¢æ¿
            document.addEventListener('click', function(e) {
                const notificationPanel = document.getElementById('notification-panel');
                const notificationBtn = document.getElementById('notification-btn');
                
                if (notificationPanel.style.display === 'flex' && 
                    !notificationPanel.contains(e.target) && 
                    e.target !== notificationBtn) {
                    notificationPanel.style.display = 'none';
                }
            });
            
            // åˆå§‹åŒ–WebSocketè¿æ¥
            initWebSocket();
        });

        // åˆå§‹åŒ–WebSocketè¿æ¥
        function initWebSocket() {
            // è¿æ¥åˆ° WebSocket æœåŠ¡å™¨
            webSocketManager.connect()
                .then(() => {
                    console.log('WebSocket connected successfully');
                    
                    // è®¢é˜…åœ¨çº¿ç”¨æˆ·æ›´æ–°ä¸»é¢˜
                    subscriptionId = webSocketManager.subscribe('/topic/online-users', function(message) {
                        // åªå¤„ç†åœ¨çº¿ç”¨æˆ·æ›´æ–°çš„æ¶ˆæ¯
                        if (message && message.type === 'online-users') {
                            handleOnlineUsersUpdate(message);
                        }
                    });
                    
                    // è®¢é˜…å…¬å…±é€šçŸ¥ä¸»é¢˜
                    webSocketManager.subscribe('/topic/public', function(notification) {
                        showNotification(notification);
                    });
                    
                    // è®¢é˜…ç§èŠé€šçŸ¥ä¸»é¢˜
                    webSocketManager.subscribe('/user/queue/messages', function(notification) {
                        showNotification(notification);
                    });
                })
                .catch(error => {
                    console.error('Failed to connect to WebSocket:', error);
                    showToast('æ— æ³•è¿æ¥åˆ°é€šçŸ¥æœåŠ¡å™¨');
                });
        }

        // å¤„ç†åœ¨çº¿ç”¨æˆ·æ›´æ–°
        function handleOnlineUsersUpdate(message) {
            console.log('Received online users update:', message);
            // é‡æ–°åŠ è½½åœ¨çº¿ç”¨æˆ·åˆ—è¡¨
            loadOnlineUsers();
        }
        
        // æ˜¾ç¤ºé€šçŸ¥
        function showNotification(notification) {
            console.log('Received notification:', notification);
            
            // æ£€æŸ¥é€šçŸ¥æ˜¯å¦æœ‰æ•ˆ
            if (!notification) {
                return;
            }
            
            // è·å–é€šçŸ¥æ¶ˆæ¯æ–‡æœ¬
            const message = getNotificationMessage(notification);
            
            // å¦‚æœæ¶ˆæ¯ä¸ºç©ºæˆ–æœªå®šä¹‰ï¼Œåˆ™ä¸æ˜¾ç¤º
            if (!message || message === 'undefined' || message.trim() === '') {
                return;
            }
            
            // å¢åŠ æœªè¯»é€šçŸ¥è®¡æ•°
            notificationCount++;
            updateNotificationBadge();
            
            // æ·»åŠ é€šçŸ¥åˆ°é€šçŸ¥é¢æ¿
            addNotificationToPanel(notification);
            
            // æ˜¾ç¤ºToastæ¶ˆæ¯ - åªæœ‰åœ¨æ¶ˆæ¯æœ‰æ•ˆæ—¶æ‰æ˜¾ç¤º
            showToast(message);
        }
        
        // è·å–é€šçŸ¥æ¶ˆæ¯æ–‡æœ¬
        function getNotificationMessage(notification) {
            // æ£€æŸ¥é€šçŸ¥æ˜¯å¦æœ‰æ•ˆ
            if (!notification) {
                return '';
            }
            
            // æ ¹æ®ä¸åŒç±»å‹ç”Ÿæˆæ¶ˆæ¯æ–‡æœ¬
            switch(notification.type) {
                case 'task':
                    if (notification.action && notification.data && notification.data.title) {
                        return `ä»»åŠ¡æ›´æ–°: ${notification.action}ä»»åŠ¡ ${notification.data.title}`;
                    } else if (notification.data && notification.data.title) {
                        return `ä»»åŠ¡æ›´æ–°: ${notification.data.title}`;
                    } else {
                        return 'æ‚¨æœ‰ä¸€ä¸ªæ–°ä»»åŠ¡';
                    }
                case 'comment':
                    if (notification.action==='create'&& notification.data.content) {
                       return `${notification.data.author}å‘è¡¨äº†æ–°çš„çš„è¯„è®º`;
                    } else if(notification.action==='like'&& notification.data===currentUsername)
                    {
                       return `${notification.sender}ç‚¹èµäº†ä½ çš„è¯„è®º`;

                    }
                    // å¦‚æœä¸æ˜¯ç‚¹èµä½ çš„è¯„è®ºï¼Œä¸æ˜¾ç¤ºé€šçŸ¥
                    else if(notification.action==='like'&& notification.data!==currentUsername) {
                        return; // ç›´æ¥è¿”å›ï¼Œä¸æ˜¾ç¤ºé€šçŸ¥
                    }
                    else {
                        return 'æ‚¨æœ‰ä¸€æ¡è¯„è®º';
                    }
                    break;
                case 'online-users':
                    return 'åœ¨çº¿ç”¨æˆ·åˆ—è¡¨å·²æ›´æ–°';
                default:
                    // å°è¯•ä»å¸¸è§çš„å­—æ®µä¸­è·å–æ¶ˆæ¯å†…å®¹
                    if (notification.content) {
                        return notification.content;
                    } else if (notification.message) {
                        return notification.message;
                    } else if (notification.text) {
                        return notification.text;
                    } else {
                        // å¦‚æœæ²¡æœ‰å¯è¯†åˆ«çš„å†…å®¹ï¼Œè¿”å›ç©ºå­—ç¬¦ä¸²
                        return '';
                    }
            }
        }
        
        // æ·»åŠ é€šçŸ¥åˆ°é¢æ¿
        function addNotificationToPanel(notification) {
            // æ£€æŸ¥é€šçŸ¥æ˜¯å¦æœ‰æ•ˆ
            if (!notification) {
                return;
            }
            
            // è·å–é€šçŸ¥æ¶ˆæ¯
            const message = getNotificationMessage(notification);
            
            // å¦‚æœæ¶ˆæ¯ä¸ºç©ºï¼Œåˆ™ä¸æ·»åŠ åˆ°é¢æ¿
            if (!message || message === 'undefined' || message.trim() === '') {
                return;
            }
            
            const container = document.getElementById('notifications-container');
            
            // åˆ›å»ºé€šçŸ¥å…ƒç´ 
            const notificationEl = document.createElement('div');
            notificationEl.className = 'notification-item unread';
            notificationEl.innerHTML = `
                <div class="notification-title">${getNotificationTitle(notification)}</div>
                <div class="notification-message">${message}</div>
                <div class="notification-time">${formatNotificationTime(notification.timestamp)}</div>
            `;
            
            // æ·»åŠ ç‚¹å‡»äº‹ä»¶
            notificationEl.addEventListener('click', function() {
                // æ ‡è®°ä¸ºå·²è¯»
                this.classList.remove('unread');
                // å‡å°‘æœªè¯»è®¡æ•°
                if (notificationCount > 0) {
                    notificationCount--;
                    updateNotificationBadge();
                }
            });
            
            // å°†æ–°é€šçŸ¥æ’å…¥åˆ°é¡¶éƒ¨
            if (container.firstChild) {
                container.insertBefore(notificationEl, container.firstChild);
            } else {
                container.appendChild(notificationEl);
            }
        }
        
        // è·å–é€šçŸ¥æ ‡é¢˜
        function getNotificationTitle(notification) {
            // æ£€æŸ¥é€šçŸ¥æ˜¯å¦æœ‰æ•ˆ
            if (!notification) {
                return 'æœªçŸ¥é€šçŸ¥';
            }
            
            switch(notification.type) {
                case 'task':
                    return 'ä»»åŠ¡é€šçŸ¥';
                case 'comment':
                    return 'è¯„è®ºé€šçŸ¥';
                case 'online-users':
                    return 'ç”¨æˆ·çŠ¶æ€';
                default:
                    // å°è¯•ä»é€šçŸ¥ä¸­è·å–æ ‡é¢˜ç›¸å…³ä¿¡æ¯
                    if (notification.title) {
                        return notification.title;
                    } else if (notification.subject) {
                        return notification.subject;
                    } else {
                        return 'ç³»ç»Ÿé€šçŸ¥';
                    }
            }
        }
        
        // æ ¼å¼åŒ–é€šçŸ¥æ—¶é—´
        function formatNotificationTime(timestamp) {
            // å¦‚æœæ²¡æœ‰æ—¶é—´æˆ³ï¼Œè¿”å›é»˜è®¤å€¼
            if (!timestamp) return 'åˆšåˆš';
            
            let notificationTime;
            
            // å°è¯•è§£æä¸åŒæ ¼å¼çš„æ—¶é—´æˆ³
            if (typeof timestamp === 'string') {
                // å°è¯•è§£æISOå­—ç¬¦ä¸²
                notificationTime = new Date(timestamp);
                if (isNaN(notificationTime.getTime())) {
                    // å¦‚æœè§£æå¤±è´¥ï¼Œå°è¯•å…¶ä»–æ ¼å¼
                    notificationTime = new Date(parseInt(timestamp));
                }
            } else if (typeof timestamp === 'number') {
                // å¦‚æœæ˜¯æ•°å­—ï¼Œå‡è®¾æ˜¯æ¯«ç§’æ—¶é—´æˆ³
                notificationTime = new Date(timestamp);
            } else {
                // å¦‚æœæ˜¯Dateå¯¹è±¡æˆ–å…¶ä»–æ ¼å¼
                notificationTime = new Date(timestamp);
            }
            
            // æ£€æŸ¥æ—¥æœŸæ˜¯å¦æœ‰æ•ˆ
            if (isNaN(notificationTime.getTime())) {
                return 'æœªçŸ¥æ—¶é—´';
            }
            
            const now = new Date();
            const diffMs = now - notificationTime;
            const diffMins = Math.floor(diffMs / 60000);
            const diffHours = Math.floor(diffMs / 3600000);
            const diffDays = Math.floor(diffMs / 86400000);
            
            if (diffMins < 1) {
                return 'åˆšåˆš';
            } else if (diffMins < 60) {
                return `${diffMins}åˆ†é’Ÿå‰`;
            } else if (diffHours < 24) {
                return `${diffHours}å°æ—¶å‰`;
            } else {
                return `${diffDays}å¤©å‰`;
            }
        }
        
        // æ›´æ–°é€šçŸ¥å¾½ç« 
        function updateNotificationBadge() {
            const badge = document.getElementById('notification-badge');
            if (notificationCount > 0) {
                badge.textContent = notificationCount;
                badge.style.display = 'inline';
            } else {
                badge.style.display = 'none';
            }
        }
        
        // åˆ‡æ¢é€šçŸ¥é¢æ¿æ˜¾ç¤º/éšè—
        function toggleNotificationPanel() {
            const panel = document.getElementById('notification-panel');
            if (panel.style.display === 'flex') {
                panel.style.display = 'none';
            } else {
                panel.style.display = 'flex';
                // æ‰“å¼€é¢æ¿æ—¶é‡ç½®æœªè¯»è®¡æ•°
                notificationCount = 0;
                updateNotificationBadge();
                
                // æ ‡è®°æ‰€æœ‰é€šçŸ¥ä¸ºå·²è¯»
                const notifications = document.querySelectorAll('.notification-item.unread');
                notifications.forEach(notification => {
                    notification.classList.remove('unread');
                });
            }
        }
        
        // æ¸…é™¤æ‰€æœ‰é€šçŸ¥
        function clearNotifications() {
            const container = document.getElementById('notifications-container');
            container.innerHTML = '<div class="text-center text-muted py-3">æš‚æ— é€šçŸ¥</div>';
            notificationCount = 0;
            updateNotificationBadge();
        }
        
        // è·å–åœ¨çº¿ç”¨æˆ·åˆ—è¡¨
        async function loadOnlineUsers() {
            try {
                const response = await fetch('/api/users/online', {
                    method: 'GET',
                    headers: {
                        'Content-Type': 'application/json'
                    }
                });
                
                if (response.ok) {
                    allUsers = await response.json();
                    document.getElementById('online-count').textContent = allUsers.length;
                    renderUsers();
                } else {
                    showToast('Failed to load online users');
                }
            } catch (error) {
                console.error('Error loading online users:', error);
                showToast('Error loading online users');
            }
        }

        // æ¸²æŸ“ç”¨æˆ·åˆ—è¡¨
        function renderUsers() {
            const totalPages = Math.ceil(allUsers.length / pageSize);
            const startIndex = (currentPage - 1) * pageSize;
            const endIndex = Math.min(startIndex + pageSize, allUsers.length);
            const usersToShow = allUsers.slice(startIndex, endIndex);
            
            const container = document.getElementById('users-container');
            container.innerHTML = '';
            
            if (usersToShow.length === 0) {
                container.innerHTML = `
                    <div class="col-12">
                        <div class="alert alert-info text-center">
                            No online users found
                        </div>
                    </div>
                `;
                renderPagination(totalPages);
                return;
            }
            
            usersToShow.forEach(user => {
                const userCard = document.createElement('div');
                userCard.className = 'col-lg-4 col-md-6 col-sm-12 mb-4';
                userCard.innerHTML = `
                    <div class="card user-card h-100">
                        <div class="card-body">
                            <div class="d-flex align-items-center mb-3">
                                <img src="${user.avatarUrl || '/uploads/avatars/default.png'}"
                                     alt="Avatar"
                                     class="rounded-circle me-3"
                                     width="50"
                                     height="50"
                                     onerror="this.src='/images/default-avatar.png'">
                                <div>
                                    <h5 class="card-title mb-0">${user.username}</h5>
                                    <small class="text-muted">
                                        <span class="online-indicator"></span>
                                        Online
                                    </small>
                                </div>
                            </div>
                            <div class="mb-2">
                                <small class="text-muted">Email:</small>
                                <div>${user.email || 'Not provided'}</div>
                            </div>
                            <div class="mb-2">
                                <small class="text-muted">Phone:</small>
                                <div>${user.phoneNumber || 'Not provided'}</div>
                            </div>
                            <div class="d-flex justify-content-between align-items-center mt-3">
                                <span class="badge bg-primary">User</span>
                                ${user.username === currentUsername ? 
                                    '<span class="badge bg-success">You</span>' : 
                                    `<button class="btn btn-sm btn-outline-primary invite-btn" 
                                             data-username="${user.username}"
                                             data-uuid="${user.invitationUuid}">
                                        ğŸ“¨ Invite
                                    </button>`}
                            </div>
                        </div>
                    </div>
                `;
                container.appendChild(userCard);
            });
            
            // ç»‘å®šé‚€è¯·æŒ‰é’®äº‹ä»¶
            document.querySelectorAll('.invite-btn').forEach(button => {
                button.addEventListener('click', function() {
                    const username = this.getAttribute('data-username');
                    const uuid = this.getAttribute('data-uuid');
                    copyToClipboard(uuid);
                    showToast(`Invitation UUID for ${username} copied to clipboard!`);
                });
            });
            
            renderPagination(totalPages);
        }

        // æ¸²æŸ“åˆ†é¡µæ§ä»¶
        function renderPagination(totalPages) {
            const pagination = document.getElementById('pagination');
            pagination.innerHTML = '';
            
            if (totalPages <= 1) {
                return;
            }
            
            // ä¸Šä¸€é¡µæŒ‰é’®
            const prevLi = document.createElement('li');
            prevLi.className = `page-item ${currentPage === 1 ? 'disabled' : ''}`;
            prevLi.innerHTML = `
                <a class="page-link" href="#" aria-label="Previous">
                    <span aria-hidden="true">&laquo;</span>
                </a>
            `;
            if (currentPage > 1) {
                prevLi.querySelector('a').addEventListener('click', function(e) {
                    e.preventDefault();
                    currentPage--;
                    renderUsers();
                });
            }
            pagination.appendChild(prevLi);
            
            // é¡µç æŒ‰é’®
            for (let i = 1; i <= totalPages; i++) {
                const li = document.createElement('li');
                li.className = `page-item ${i === currentPage ? 'active' : ''}`;
                li.innerHTML = `<a class="page-link" href="#">${i}</a>`;
                
                if (i !== currentPage) {
                    li.querySelector('a').addEventListener('click', function(e) {
                        e.preventDefault();
                        currentPage = i;
                        renderUsers();
                    });
                }
                
                pagination.appendChild(li);
            }
            
            // ä¸‹ä¸€é¡µæŒ‰é’®
            const nextLi = document.createElement('li');
            nextLi.className = `page-item ${currentPage === totalPages ? 'disabled' : ''}`;
            nextLi.innerHTML = `
                <a class="page-link" href="#" aria-label="Next">
                    <span aria-hidden="true">&raquo;</span>
                </a>
            `;
            if (currentPage < totalPages) {
                nextLi.querySelector('a').addEventListener('click', function(e) {
                    e.preventDefault();
                    currentPage++;
                    renderUsers();
                });
            }
            pagination.appendChild(nextLi);
        }

        // å¤åˆ¶åˆ°å‰ªè´´æ¿
        function copyToClipboard(text) {
            const textarea = document.createElement('textarea');
            textarea.value = text;
            document.body.appendChild(textarea);
            textarea.select();
            document.execCommand('copy');
            document.body.removeChild(textarea);
        }

        // Toastæ¶ˆæ¯æ˜¾ç¤º
        function showToast(message) {
            // å¦‚æœæ¶ˆæ¯ä¸ºç©ºæˆ–æœªå®šä¹‰ï¼Œåˆ™ä¸æ˜¾ç¤º
            if (!message || message === 'undefined' || message.trim() === '') {
                return;
            }
            
            const toastContainer = document.getElementById('toast-container');
            const toast = document.createElement('div');
            toast.className = 'toast show';
            toast.innerHTML = `
                <div class="toast-body">
                    ${message}
                </div>
            `;
            toastContainer.appendChild(toast);
            
            // 3ç§’åè‡ªåŠ¨ç§»é™¤
            setTimeout(() => {
                if (toast.parentNode) {
                    toast.remove();
                }
            }, 3000);
        }
        
        // æ‰§è¡Œç™»å‡ºæ“ä½œ
        function performLogout() {
            fetch('/api/auth/logout', {
                method: 'POST',
                headers: {
                    'Content-Type': 'application/json'
                }
            })
            .then(response => {
                if (response.ok) {
                    // ç™»å‡ºæˆåŠŸï¼Œé‡å®šå‘åˆ°ç™»å½•é¡µé¢
                    window.location.href = '/login?logout';
                } else {
                    console.error('Logout failed');
                    // å³ä½¿å¤±è´¥ä¹Ÿé‡å®šå‘åˆ°ç™»å½•é¡µé¢
                    window.location.href = '/login?logout';
                }
            })
            .catch(error => {
                console.error('Logout error:', error);
                // å³ä½¿å‡ºé”™ä¹Ÿé‡å®šå‘åˆ°ç™»å½•é¡µé¢
                window.location.href = '/login?logout';
            });
        }
    </script>
</body>
</html>