<!DOCTYPE html>
<html xmlns:th="http://www.thymeleaf.org">
<head>
    <title>Code Share Dashboard</title>
    <meta charset="utf-8">
    <meta name="viewport" content="width=device-width, initial-scale=1">
    <!-- Bootstrap CSSæ¡†æ¶ -->
    <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.3/dist/css/bootstrap.min.css" rel="stylesheet">
    <!-- å…¨å±€æ ·å¼è¡¨ -->
    <link rel="stylesheet" th:href="@{/style.css}">
    <!-- ä»ªè¡¨æ¿é¡µé¢ä¸“ç”¨æ ·å¼è¡¨ -->
    <link rel="stylesheet" th:href="@{/css/dashboard.css}">
</head>
<body>
<!-- é¡¶éƒ¨å¯¼èˆªæ  -->
<nav class="navbar navbar-expand-lg navbar-dark bg-dark">
    <div class="container-fluid">
        <!-- ç½‘ç«™é“¾æ¥ -->
        <a class="navbar-brand" href="/">ğŸ“ Code Share</a>
        <div class="navbar-nav ms-auto">
            <div class="nav-item dropdown">
                <!-- ç”¨æˆ·ä¸‹æ‹‰èœå•è§¦å‘å™¨ -->
                <a class="nav-link dropdown-toggle d-flex align-items-center" href="#" id="navbarDropdown" role="button" data-bs-toggle="dropdown" aria-expanded="false">
                    <!-- å¦‚æœç”¨æˆ·æœ‰å¤´åƒåˆ™æ˜¾ç¤ºå¤´åƒï¼Œå¦åˆ™æ˜¾ç¤ºé»˜è®¤å¤´åƒ -->
                    <img th:if="${currentUser.avatarUrl}" th:src="${currentUser.avatarUrl}" alt="Avatar" class="rounded-circle me-2" width="32" height="32">
                    <img th:unless="${currentUser.avatarUrl}" src='/uploads/avatars/default.png' alt="Avatar" class="rounded-circle me-2" width="32" height="32">
                    <span th:text="${currentUser.username}">User</span>
                </a>
                <!-- ä¸‹æ‹‰èœå•å†…å®¹ -->
                <ul class="dropdown-menu dropdown-menu-end" aria-labelledby="navbarDropdown">
                    <!-- ä¸ªäººèµ„æ–™é“¾æ¥ -->
                    <li><a class="dropdown-item" th:href="@{/profile}">ğŸ‘¤ Profile</a></li>
                    <!-- æ“ä½œæ—¥å¿—é“¾æ¥ -->
                    <li><a class="dropdown-item" th:href="@{/logs}">ğŸ“ Operation Logs</a></li>
                    <li>
                        <!-- ç™»å‡ºè¡¨å• -->
                        <form th:action="@{/logout}" method="post" class="m-0">
                            <button type="submit" class="dropdown-item">ğŸšª Logout</button>
                        </form>
                    </li>
                </ul>
            </div>
        </div>
    </div>
</nav>

<div class="container-fluid mt-4">
    <!-- ç™»å½•æˆåŠŸæç¤ºæ¶ˆæ¯ -->
    <div th:if="${loginSuccess}" class="alert alert-success alert-dismissible fade show" role="alert">
        Welcome back! You have been successfully logged in.
        <button type="button" class="btn-close" data-bs-dismiss="alert" aria-label="Close"></button>
    </div>
    
    <!-- æ“ä½œæˆåŠŸæç¤ºæ¶ˆæ¯ -->
    <div th:if="${message}" class="alert alert-success alert-dismissible fade show" role="alert">
        <span th:text="${message}">Success message</span>
        <button type="button" class="btn-close" data-bs-dismiss="alert" aria-label="Close"></button>
    </div>
    
    <!-- é”™è¯¯æç¤ºæ¶ˆæ¯ -->
    <div th:if="${error}" class="alert alert-danger alert-dismissible fade show" role="alert">
        <span th:text="${error}">Error message</span>
        <button type="button" class="btn-close" data-bs-dismiss="alert" aria-label="Close"></button>
    </div>
    
    <!-- é¡µé¢æ ‡é¢˜å’Œæ–°å»ºæ–‡æ¡£æŒ‰é’® -->
    <div class="d-flex justify-content-between align-items-center mb-4">
        <h1>Dashboard</h1>
        <!-- æ–°å»ºæ–‡æ¡£è¡¨å• -->
        <form th:action="@{/documents/create}" method="post">
            <button type="submit" class="btn btn-primary">â• New Document</button>
        </form>
    </div>

    <div class="row">
        <div class="col-md-8">
            <h3>Your Documents</h3>
            <!-- æ— æ–‡æ¡£æ—¶çš„æç¤ºä¿¡æ¯ -->
            <div th:if="${documents.empty}" class="alert alert-info">
                You don't have any documents yet. Create your first document!
            </div>
            <!-- åœ¨é¡µé¢é¡¶éƒ¨æ·»åŠ æ ‡ç­¾ç­›é€‰å™¨ -->
            <div class="row mb-3">
                <div class="col-md-12">
                    <h5>æŒ‰æ ‡ç­¾ç­›é€‰:</h5>
                    <!-- æ·»åŠ æ ‡ç­¾æœç´¢è¾“å…¥æ¡† -->
                    <div class="mb-2">
                        <input type="text" id="tagSearchInput" class="form-control form-control-sm" placeholder="è¾“å…¥æ ‡ç­¾åç§°è¿›è¡Œç­›é€‰..." th:value="${tagsFilter}">
                    </div>
                    <div id="tagFilters" class="mb-2">
                        <!-- æ ‡ç­¾ç­›é€‰æŒ‰é’®å°†é€šè¿‡JavaScriptåŠ¨æ€ç”Ÿæˆ -->
                    </div>
                    <!-- æ¸…é™¤æ ‡ç­¾ç­›é€‰æŒ‰é’® -->
                    <button id="clearTagFilter" class="btn btn-sm btn-outline-secondary">æ¸…é™¤ç­›é€‰</button>
                </div>
            </div>
            
            <!-- æ·»åŠ æ–‡æ¡£å†…å®¹æœç´¢æ¡† -->
            <div class="row mb-3">
                <div class="col-md-12">
                    <h5>æŒ‰å†…å®¹æœç´¢:</h5>
                    <div class="input-group">
                        <input type="text" id="contentSearchInput" class="form-control" placeholder="è¾“å…¥å…³é”®å­—æœç´¢æ–‡æ¡£å†…å®¹...">
                        <button id="contentSearchBtn" class="btn btn-primary">æœç´¢</button>
                        <button id="clearContentSearchBtn" class="btn btn-outline-secondary">æ¸…é™¤</button>
                    </div>
                </div>
            </div>
            
            <!-- æ–‡æ¡£åˆ—è¡¨ -->
            <div th:unless="${documents.empty}" class="row row-cols-1 row-cols-md-2 g-4">
                <div th:each="doc : ${documents}" class="col">
                    <!-- å•ä¸ªæ–‡æ¡£å¡ç‰‡ -->
                    <div class="card h-100 document-card">
                        <div class="card-body">
                            <!-- æ–‡æ¡£æ ‡é¢˜ -->
                            <h5 class="card-title" th:text="${doc.title ?: 'Untitled Document'}">Document Title</h5>
                            <!-- æ·»åŠ æ ‡ç­¾æ˜¾ç¤º -->
                            <div class="tags mb-2">
                                <span>tags:</span>
                                <span th:if="${doc.tags}" th:each="tag : ${doc.getTagList()}"
                                    class="badge bg-secondary me-1"
                                        th:text="${tag}"></span>
                                <span th:unless="${doc.tags}">None</span>
                            </div>
                            <!-- æ·»åŠ æ‹¥æœ‰è€…ä¿¡æ¯æ˜¾ç¤º -->
                            <div class="mb-2">
                                <small class="text-muted">
                                    <i class="fas fa-user"></i> Owner:
                                    <span th:text="${doc.owner.username}">Owner Name</span>
                                </small>
                            </div>  <!-- TODO -->
                            <!-- æ–‡æ¡£åˆ›å»ºå’Œæ›´æ–°æ—¶é—´ -->
                            <p class="card-text text-muted">
                                <small>
                                    Created: <span th:text="${#dates.format(doc.createdAt, 'yyyy-MM-dd HH:mm')}">Date</span>
                                    <br>
                                    Updated: <span th:text="${#dates.format(doc.updatedAt, 'yyyy-MM-dd HH:mm')}">Date</span>
                                </small>
                            </p>
                        </div>
                        <!-- æ–‡æ¡£æ“ä½œæŒ‰é’®ç»„ -->
                        <div class="card-footer">
                            <!-- ç¼–è¾‘æ–‡æ¡£æŒ‰é’® -->
                            <a th:href="@{/editor/{documentId}(documentId=${doc.uniqueId})}" class="btn btn-primary btn-sm">âœï¸ Edit</a>
                            <!-- å¤åˆ¶æ–‡æ¡£IDæŒ‰é’® -->
                            <button class="btn btn-outline-secondary btn-sm copy-btn"
                                    th:data-doc-id="${doc.uniqueId}"
                                    th:data-doc-title="${doc.title ?: 'Untitled Document'}">ğŸ“‹ Copy ID</button>
                            <!-- åˆ é™¤æ–‡æ¡£æŒ‰é’® -->
                            <button class="btn btn-outline-danger btn-sm delete-btn"
                                    th:data-doc-id="${doc.uniqueId}"
                                    th:data-doc-title="${doc.title ?: 'Untitled Document'}">ğŸ—‘ï¸ Delete</button>
                            <!-- ç¼–è¾‘æ–‡æ¡£æ ‡é¢˜æŒ‰é’® -->
                            <button class="btn btn-outline-secondary btn-sm edit-title-btn"
                                    th:data-doc-id="${doc.uniqueId}"
                                    th:data-doc-title="${doc.title ?: 'Untitled Document'}">âœï¸ Rename</button>
                            <!-- æ·»åŠ æ ‡ç­¾æŒ‰é’® -->
                            <button class="btn btn-outline-secondary btn-sm add-tag-btn"
                                    th:data-doc-id="${doc.uniqueId}"
                                    th:data-doc-title="${doc.title ?: 'Untitled Document'}">ğŸ·ï¸ Add Tag</button>
                        </div>
                    </div>
                </div>
            </div>
        </div>


        <div class="col-md-4">
            <!-- åŠ å…¥æ–‡æ¡£å¡ç‰‡ -->
            <div class="card">
                <div class="card-header">
                    <h5>ğŸ‘¥ Join Document</h5>
                </div>
                <div class="card-body">
                    <!-- åŠ å…¥æ–‡æ¡£è¡¨å• -->
                    <form th:action="@{/documents/join}" method="post">
                        <div class="mb-3">
                            <label for="documentId" class="form-label">Document ID</label>
                            <input type="text" class="form-control" id="documentId" name="documentId" required>
                        </div>
                        <button type="submit" class="btn btn-success">ğŸ”— Join</button>
                    </form>
                </div>
            </div>

            <!-- æ“ä½œå¡ç‰‡ -->
            <div class="card mt-4">
                <div class="card-header">
                    <h5>ğŸ“Š Operations</h5>
                </div>
                <div class="card-body">
                    <a href="/logs" class="btn btn-info w-100 mb-2">ğŸ“ View Operation Logs</a>
                </div>
            </div>

            <!-- ç”¨æˆ·ä¿¡æ¯å¡ç‰‡ -->
            <div class="card mt-4">
                <div class="card-header">
                    <h5>ğŸ‘¤ User Info</h5>
                </div>
                <div class="card-body">
                    <div class="d-flex align-items-center mb-3">
                        <!-- ç”¨æˆ·å¤´åƒ -->
                        <img th:if="${currentUser.avatarUrl}" th:src="${currentUser.avatarUrl}" alt="Avatar" class="rounded-circle me-3" width="64" height="64">
                        <img th:unless="${currentUser.avatarUrl}" src='/uploads/avatars/default.png' alt="Avatar" class="rounded-circle me-3" width="64" height="64">
                        <div>
                            <!-- ç”¨æˆ·å -->
                            <h6 class="mb-0" th:text="${currentUser.username}">Username</h6>
                            <small class="text-muted">User</small>
                        </div>
                    </div>
                    <!-- ç”¨æˆ·é‚®ç®±å’Œç”µè¯ä¿¡æ¯ -->
                    <p class="mb-1"><strong>Email:</strong> <span th:text="${currentUser.email ?: 'Not provided'}">email@example.com</span></p>
                    <p class="mb-0"><strong>Phone:</strong> <span th:text="${currentUser.phoneNumber ?: 'Not provided'}">Not provided</span></p>
                </div>
            </div>

        </div>
    </div>
</div>

<!-- Toastæ¶ˆæ¯å®¹å™¨ -->
<div id="toast-container" class="toast-container position-fixed bottom-0 end-0 p-3" style="z-index: 1055;"></div>

<!-- æ·»åŠ æ ‡ç­¾æ¨¡æ€æ¡† -->
<div class="modal fade" id="addTagModal" tabindex="-1" aria-labelledby="addTagModalLabel" aria-hidden="true">
    <div class="modal-dialog">
        <div class="modal-content">
            <div class="modal-header">
                <h5 class="modal-title" id="addTagModalLabel">æ·»åŠ æ ‡ç­¾</h5>
                <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Close"></button>
            </div>
            <div class="modal-body">
                <form id="addTagForm">
                    <input type="hidden" id="tagDocumentId">
                    <div class="mb-3">
                        <label for="tagInput" class="form-label">æ ‡ç­¾åç§°</label>
                        <input type="text" class="form-control" id="tagInput" placeholder="è¾“å…¥æ ‡ç­¾åç§°ï¼Œå¤šä¸ªæ ‡ç­¾ç”¨é€—å·åˆ†éš”">
                        <div class="form-text">å¯ä»¥è¾“å…¥å¤šä¸ªæ ‡ç­¾ï¼Œç”¨é€—å·åˆ†éš”</div>
                    </div>
                </form>
            </div>
            <div class="modal-footer">
                <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">å–æ¶ˆ</button>
                <button type="button" class="btn btn-primary" id="saveTagBtn">ä¿å­˜</button>
            </div>
        </div>
    </div>
</div>

<script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.3/dist/js/bootstrap.bundle.min.js"></script>
<script th:inline="javascript">
    /*<![CDATA[*/
    document.addEventListener('DOMContentLoaded', function() {
        loadAllTags();
        // åˆå§‹åŒ– Bootstrap ç»„ä»¶
        var dropdownElementList = [].slice.call(document.querySelectorAll('[data-bs-toggle="dropdown"]'));
        dropdownElementList.map(function(dropdownToggleEl) {
            return new bootstrap.Dropdown(dropdownToggleEl);
        });

        // åˆå§‹åŒ– Alerts
        var alertList = [].slice.call(document.querySelectorAll('.alert'));
        alertList.map(function(alertEl) {
            return new bootstrap.Alert(alertEl);
        });
        
        // æ·»åŠ æ ‡ç­¾æœç´¢è¾“å…¥æ¡†çš„äº‹ä»¶ç›‘å¬å™¨
        const tagSearchInput = document.getElementById('tagSearchInput');
        if (tagSearchInput) {
            // ç›‘å¬è¾“å…¥äº‹ä»¶
            tagSearchInput.addEventListener('input', function() {
                filterTags(this.value);
            });
            
            // å¦‚æœé¡µé¢åŠ è½½æ—¶æœ‰æ ‡ç­¾ç­›é€‰å‚æ•°ï¼Œè®¾ç½®æœç´¢æ¡†çš„å€¼
            // é€šè¿‡Thymeleafè®¾ç½®æœç´¢æ¡†çš„å€¼
        }
        
        // æ·»åŠ å†…å®¹æœç´¢åŠŸèƒ½
        const contentSearchBtn = document.getElementById('contentSearchBtn');
        const contentSearchInput = document.getElementById('contentSearchInput');
        const clearContentSearchBtn = document.getElementById('clearContentSearchBtn');
        
        if (contentSearchBtn && contentSearchInput) {
            contentSearchBtn.addEventListener('click', function() {
                const keyword = contentSearchInput.value.trim();
                if (keyword) {
                    searchDocumentsByContent(keyword);
                }
            });
            
            // æ”¯æŒå›è½¦é”®æœç´¢
            contentSearchInput.addEventListener('keypress', function(e) {
                if (e.key === 'Enter') {
                    const keyword = contentSearchInput.value.trim();
                    if (keyword) {
                        searchDocumentsByContent(keyword);
                    }
                }
            });
        }
        
        if (clearContentSearchBtn) {
            clearContentSearchBtn.addEventListener('click', function() {
                contentSearchInput.value = '';
                // é‡æ–°åŠ è½½é¡µé¢æ˜¾ç¤ºæ‰€æœ‰æ–‡æ¡£
                window.location.href = '/';
            });
        }
        
        // ç»‘å®šåˆå§‹æ–‡æ¡£å¡ç‰‡äº‹ä»¶
        bindDocumentCardEvents();
    });

    // æ·»åŠ æ ‡ç­¾æŒ‰é’®äº‹ä»¶ç›‘å¬å™¨
    document.querySelectorAll('.add-tag-btn').forEach(button => {
        button.addEventListener('click', function() {
            const docId = this.getAttribute('data-doc-id');
            const docTitle = this.getAttribute('data-doc-title');
            
            // è®¾ç½®æ¨¡æ€æ¡†ä¸­çš„æ–‡æ¡£ID
            document.getElementById('tagDocumentId').value = docId;
            
            // æ¸…ç©ºä¹‹å‰çš„è¾“å…¥
            document.getElementById('tagInput').value = '';
            
            // æ˜¾ç¤ºæ¨¡æ€æ¡†
            const modal = new bootstrap.Modal(document.getElementById('addTagModal'));
            modal.show();
        });
    });

    // ä¿å­˜æ ‡ç­¾æŒ‰é’®äº‹ä»¶ç›‘å¬å™¨
    document.getElementById('saveTagBtn').addEventListener('click', function() {
        const docId = document.getElementById('tagDocumentId').value;
        const tagInput = document.getElementById('tagInput').value;
        
        if (!tagInput.trim()) {
            showToast('è¯·è¾“å…¥è‡³å°‘ä¸€ä¸ªæ ‡ç­¾!', 'danger');
            return;
        }
        
        // å‘é€æ·»åŠ æ ‡ç­¾è¯·æ±‚
        fetch(`/documents/add-tags/${docId}`, {
            method: 'POST',
            headers: {
                'Content-Type': 'application/json',
                'X-Requested-With': 'XMLHttpRequest'
            },
            body: JSON.stringify({ tags: tagInput })
        })
            .then(response => {
                if (response.ok) {
                    // å…³é—­æ¨¡æ€æ¡†
                    const modal = bootstrap.Modal.getInstance(document.getElementById('addTagModal'));
                    modal.hide();
                    
                    // æ˜¾ç¤ºæˆåŠŸæ¶ˆæ¯
                    showToast('æ ‡ç­¾æ·»åŠ æˆåŠŸ!', 'success');
                    
                    // é‡æ–°åŠ è½½é¡µé¢ä»¥åæ˜ æ›´æ”¹
                    setTimeout(() => {
                        window.location.reload();
                    }, 1000);
                } else {
                    showToast('æ·»åŠ æ ‡ç­¾å¤±è´¥!', 'danger');
                }
            })
            .catch(error => {
                console.error('Error:', error);
                showToast('æ·»åŠ æ ‡ç­¾æ—¶å‘ç”Ÿé”™è¯¯!', 'danger');
            });
    });

    // å¤åˆ¶åŠŸèƒ½é€»è¾‘
    document.querySelectorAll('.copy-btn').forEach(button => {
        button.addEventListener('click', function() {
            const docId = this.getAttribute('data-doc-id');
            const docTitle = this.getAttribute('data-doc-title');

            // ä¼˜å…ˆå°è¯•ç°ä»£ Clipboard API
            if (navigator.clipboard && navigator.clipboard.writeText) {
                navigator.clipboard.writeText(docId).then(() => {
                    showToast(`ğŸ“‹ Document ID for "${docTitle}" copied!`, 'success');
                }).catch(err => {
                    console.error('Clipboard API failed, trying fallback...', err);
                    fallbackCopyText(docId, docTitle);
                });
            } else {
                // å¦‚æœä¸æ”¯æŒï¼ˆå¦‚é HTTPS ç¯å¢ƒï¼‰ï¼Œç›´æ¥ä½¿ç”¨é™çº§æ–¹æ¡ˆ
                fallbackCopyText(docId, docTitle);
            }
        });
    });
    // æ¸…é™¤æ ‡ç­¾ç­›é€‰
    document.getElementById('clearTagFilter').addEventListener('click', function() {
        // æ¸…ç©ºæœç´¢æ¡†
        const tagSearchInput = document.getElementById('tagSearchInput');
        if (tagSearchInput) {
            tagSearchInput.value = '';
        }
        
        // é‡æ–°åŠ è½½é¡µé¢ï¼Œä¸å¸¦æ ‡ç­¾å‚æ•°
        window.location.href = '/';
    });
    
    // åˆ é™¤æ–‡æ¡£åŠŸèƒ½
    document.querySelectorAll('.delete-btn').forEach(button => {
        button.addEventListener('click', function() {
            const docId = this.getAttribute('data-doc-id');
            const docTitle = this.getAttribute('data-doc-title');

            // ç¡®è®¤å¯¹è¯æ¡†
            if (confirm(`Are you sure you want to delete the document "${docTitle}"? This action cannot be undone.`)) {
                // å‘é€åˆ é™¤è¯·æ±‚
                fetch(`/documents/delete/${docId}`, {
                    method: 'DELETE',
                    headers: {
                        'Content-Type': 'application/json',
                        'X-Requested-With': 'XMLHttpRequest'
                    }
                })
                    .then(response => {
                        if (response.ok) {
                            // é‡æ–°åŠ è½½é¡µé¢ä»¥åæ˜ æ›´æ”¹
                            window.location.reload();
                            showToast(`Document "${docTitle}" deleted successfully!`, 'success');
                        } else {
                            showToast(`Failed to delete document "${docTitle}"!`, 'danger');
                        }
                    })
                    .catch(error => {
                        console.error('Error:', error);
                        showToast(`Error deleting document "${docTitle}"!`, 'danger');
                    });
            }
        });
    });

    // ç¼–è¾‘æ–‡æ¡£æ ‡é¢˜åŠŸèƒ½
    document.querySelectorAll('.edit-title-btn').forEach(button => {
        button.addEventListener('click', function() {
            const docId = this.getAttribute('data-doc-id');
            const currentTitle = this.getAttribute('data-doc-title');

            // æç¤ºç”¨æˆ·è¾“å…¥æ–°æ ‡é¢˜
            const newTitle = prompt('Enter new title for the document:', currentTitle);

            // å¦‚æœç”¨æˆ·æ²¡æœ‰å–æ¶ˆå¹¶ä¸”è¾“å…¥äº†æ–°æ ‡é¢˜
            if (newTitle !== null && newTitle.trim() !== '' && newTitle !== currentTitle) {
                // å‘é€æ›´æ–°æ ‡é¢˜è¯·æ±‚
                fetch(`/documents/update-title/${docId}`, {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/json',
                        'X-Requested-With': 'XMLHttpRequest'
                    },
                    body: JSON.stringify({ title: newTitle.trim() })
                })
                    .then(response => {
                        if (response.ok) {
                            // é‡æ–°åŠ è½½é¡µé¢ä»¥åæ˜ æ›´æ”¹
                            window.location.reload();
                            showToast(`Document title updated to "${newTitle}"!`, 'success');
                        } else {
                            showToast(`Failed to update document title!`, 'danger');
                        }
                    })
                    .catch(error => {
                        console.error('Error:', error);
                        showToast(`Error updating document title!`, 'danger');
                    });
            }
        });
    });

    // å…¼å®¹æ€§å¤åˆ¶æ–¹æ¡ˆ (execCommand)
    function fallbackCopyText(text, title) {
        const textArea = document.createElement("textarea");
        textArea.value = text;
        document.body.appendChild(textArea);
        textArea.focus();
        textArea.select();

        try {
            const successful = document.execCommand('copy');
            if (successful) {
                showToast(`ğŸ“‹ Document ID for "${title}" copied!`, 'success');
            } else {
                showToast('Failed to copy document ID! âŒ', 'danger');
            }
        } catch (err) {
            showToast('Failed to copy document ID! âŒ', 'danger');
        }

        document.body.removeChild(textArea);
    }
    // è·å–æ‰€æœ‰æ ‡ç­¾
    function loadAllTags() {
        fetch('/documents/tags')
            .then(response => response.json())
            .then(tags => {
                renderTagFilters(tags);
                // ä¿å­˜æ‰€æœ‰æ ‡ç­¾ç”¨äºæœç´¢
                window.allTags = tags;
            })
            .catch(error => {
                console.error('Error loading tags:', error);
            });
    }
    
    // æ ¹æ®æœç´¢è¯ç­›é€‰æ ‡ç­¾
    function filterTags(searchTerm) {
        if (!window.allTags) return;
        
        const filteredTags = searchTerm ? 
            window.allTags.filter(tag => tag.toLowerCase().includes(searchTerm.toLowerCase())) :
            window.allTags;
            
        renderTagFilters(filteredTags);
    }
    
    // æ¸²æŸ“æ ‡ç­¾ç­›é€‰å™¨
    function renderTagFilters(tags) {
        const container = document.getElementById('tagFilters');
        container.innerHTML = '';

        // è·å–å½“å‰é¡µé¢URLä¸­çš„æ ‡ç­¾å‚æ•°
        const urlParams = new URLSearchParams(window.location.search);
        const currentTagsParam = urlParams.get('tags');
        const currentTags = currentTagsParam ? currentTagsParam.split(',').map(t => t.trim()).filter(t => t) : [];

        tags.forEach(tag => {
            const button = document.createElement('button');
            button.type = 'button';
            button.className = 'btn btn-sm btn-outline-primary me-2 mb-2';
            button.textContent = `${tag}`;
            button.dataset.tag = tag;
            
            // æ£€æŸ¥è¯¥æ ‡ç­¾æ˜¯å¦å·²åœ¨å½“å‰ç­›é€‰ä¸­ï¼Œå¦‚æœæ˜¯åˆ™æ”¹å˜æ ·å¼
            if (currentTags.includes(tag)) {
                button.classList.remove('btn-outline-primary');
                button.classList.add('btn-primary');
            }
            
            button.addEventListener('click', () => toggleTagInSearch(tag));
            container.appendChild(button);
        });
    }
    
    // åˆ‡æ¢æ ‡ç­¾åœ¨æœç´¢æ¡†ä¸­çš„çŠ¶æ€
    function toggleTagInSearch(tag) {
        const tagSearchInput = document.getElementById('tagSearchInput');
        if (!tagSearchInput) return;
        
        const currentTags = tagSearchInput.value.split(',').map(t => t.trim()).filter(t => t);
        const tagIndex = currentTags.indexOf(tag);
        
        if (tagIndex > -1) {
            // å¦‚æœæ ‡ç­¾å·²å­˜åœ¨ï¼Œç§»é™¤å®ƒ
            currentTags.splice(tagIndex, 1);
        } else {
            // å¦‚æœæ ‡ç­¾ä¸å­˜åœ¨ï¼Œæ·»åŠ å®ƒ
            currentTags.push(tag);
        }
        
        // æ›´æ–°æœç´¢æ¡†çš„å€¼
        tagSearchInput.value = currentTags.join(', ');
        
        // é‡æ–°åŠ è½½é¡µé¢å¹¶ä¼ é€’æ ‡ç­¾å‚æ•°
        const tagsParam = currentTags.length > 0 ? currentTags.join(',') : '';
        if (tagsParam) {
            window.location.href = `/?tags=${encodeURIComponent(tagsParam)}`;
        } else {
            // å¦‚æœæ²¡æœ‰æ ‡ç­¾ï¼Œé‡æ–°åŠ è½½é¡µé¢æ˜¾ç¤ºæ‰€æœ‰æ–‡æ¡£
            window.location.href = '/';
        }
    }
    
    // æ ¹æ®æ–‡æ¡£å†…å®¹æœç´¢æ–‡æ¡£
    function searchDocumentsByContent(keyword) {
        // æ˜¾ç¤ºåŠ è½½æç¤º
        showToast('æ­£åœ¨æœç´¢æ–‡æ¡£...', 'info');
        
        // å‘é€æœç´¢è¯·æ±‚åˆ°ç°æœ‰çš„APIç«¯ç‚¹
        fetch(`/api/search/documents?keyword=${encodeURIComponent(keyword)}`)
            .then(response => response.json())
            .then(results => {
                // éšè—ä¹‹å‰çš„toast
                hideAllToasts();
                
                if (results.length > 0) {
                    showToast(`æ‰¾åˆ° ${results.length} ä¸ªåŒ¹é…çš„æ–‡æ¡£`, 'success');
                    // æ›´æ–°æ–‡æ¡£åˆ—è¡¨æ˜¾ç¤ºæœç´¢ç»“æœ
                    updateDocumentListWithSearchResults(results);
                } else {
                    showToast('æœªæ‰¾åˆ°åŒ¹é…çš„æ–‡æ¡£', 'info');
                    // æ¸…ç©ºæ–‡æ¡£åˆ—è¡¨
                    clearDocumentList();
                }
            })
            .catch(error => {
                console.error('Search error:', error);
                hideAllToasts();
                showToast('æœç´¢è¿‡ç¨‹ä¸­å‘ç”Ÿé”™è¯¯', 'danger');
            });
    }
    
    // æ›´æ–°æ–‡æ¡£åˆ—è¡¨æ˜¾ç¤ºæœç´¢ç»“æœ
    function updateDocumentListWithSearchResults(results) {
        const documentListContainer = document.querySelector('.row.row-cols-1.row-cols-md-2.g-4');
        if (!documentListContainer) return;
        
        // æ¸…ç©ºç°æœ‰æ–‡æ¡£åˆ—è¡¨
        documentListContainer.innerHTML = '';
        
        // ä¸ºæ¯ä¸ªæœç´¢ç»“æœåˆ›å»ºæ–‡æ¡£å¡ç‰‡
        results.forEach(doc => {
            const colDiv = document.createElement('div');
            colDiv.className = 'col';
            
            const cardDiv = document.createElement('div');
            cardDiv.className = 'card h-100 document-card';
            
            const cardBody = document.createElement('div');
            cardBody.className = 'card-body';
            
            const title = document.createElement('h5');
            title.className = 'card-title';
            title.textContent = doc.title || 'Untitled Document';
            
            // DocumentSearchEntityæ²¡æœ‰tagså­—æ®µï¼Œæ‰€ä»¥æˆ‘ä»¬ä¸æ˜¾ç¤ºæ ‡ç­¾
            
            const ownerDiv = document.createElement('div');
            ownerDiv.className = 'mb-2';
            
            const ownerSmall = document.createElement('small');
            ownerSmall.className = 'text-muted';
            ownerSmall.innerHTML = '<i class="fas fa-user"></i> Owner: ' + (doc.owner || 'Unknown');
            ownerDiv.appendChild(ownerSmall);
            
            const timeP = document.createElement('p');
            timeP.className = 'card-text text-muted';
            
            const timeSmall = document.createElement('small');
            // æ³¨æ„ï¼šè¿™é‡Œä½¿ç”¨çš„æ˜¯Javaåç«¯è¿”å›çš„æ—¥æœŸæ ¼å¼
            timeSmall.innerHTML = `
                Created: ${formatJavaDate(doc.createAt)}<br>
                Updated: ${formatJavaDate(doc.updateAt)}
            `;
            timeP.appendChild(timeSmall);
            
            cardBody.appendChild(title);
            cardBody.appendChild(ownerDiv);
            cardBody.appendChild(timeP);
            
            const cardFooter = document.createElement('div');
            cardFooter.className = 'card-footer';
            
            const editLink = document.createElement('a');
            editLink.href = `/editor/${doc.uniqueId}`;
            editLink.className = 'btn btn-primary btn-sm';
            editLink.textContent = 'âœï¸ Edit';
            
            const copyBtn = document.createElement('button');
            copyBtn.className = 'btn btn-outline-secondary btn-sm copy-btn';
            copyBtn.setAttribute('data-doc-id', doc.uniqueId);
            copyBtn.setAttribute('data-doc-title', doc.title || 'Untitled Document');
            copyBtn.textContent = 'ğŸ“‹ Copy ID';
            
            // å¯¹äºæœç´¢ç»“æœï¼Œæˆ‘ä»¬ä¸æ˜¾ç¤ºåˆ é™¤ã€é‡å‘½åå’Œæ·»åŠ æ ‡ç­¾æŒ‰é’®ï¼Œå› ä¸ºç”¨æˆ·å¯èƒ½æ²¡æœ‰æƒé™æ‰§è¡Œè¿™äº›æ“ä½œ
            // åªæ˜¾ç¤ºç¼–è¾‘æŒ‰é’®ï¼Œç‚¹å‡»åä¼šåœ¨ç¼–è¾‘å™¨é¡µé¢æ£€æŸ¥æƒé™
            
            cardFooter.appendChild(editLink);
            cardFooter.appendChild(copyBtn);
            
            cardDiv.appendChild(cardBody);
            cardDiv.appendChild(cardFooter);
            
            colDiv.appendChild(cardDiv);
            documentListContainer.appendChild(colDiv);
        });
        
        // é‡æ–°ç»‘å®šæŒ‰é’®äº‹ä»¶
        bindDocumentCardEvents();
    }
    
    // æ¸…ç©ºæ–‡æ¡£åˆ—è¡¨
    function clearDocumentList() {
        const documentListContainer = document.querySelector('.row.row-cols-1.row-cols-md-2.g-4');
        if (documentListContainer) {
            documentListContainer.innerHTML = '<div class="col"><div class="alert alert-info">æœªæ‰¾åˆ°åŒ¹é…çš„æ–‡æ¡£</div></div>';
        }
    }
    
    // æ ¼å¼åŒ–Javaåç«¯è¿”å›çš„æ—¥æœŸæ˜¾ç¤º
    function formatJavaDate(dateString) {
        if (!dateString) return 'Unknown';
        // Javaåç«¯è¿”å›çš„æ—¥æœŸæ ¼å¼é€šå¸¸æ˜¯è¿™æ ·çš„ï¼š"2023-12-01T10:30:00.000+00:00"
        const date = new Date(dateString);
        return date.toLocaleDateString('zh-CN', {
            year: 'numeric',
            month: '2-digit',
            day: '2-digit',
            hour: '2-digit',
            minute: '2-digit'
        });
    }
    
    // éšè—æ‰€æœ‰toastæ¶ˆæ¯
    function hideAllToasts() {
        const toastContainer = document.getElementById('toast-container');
        if (toastContainer) {
            const toasts = toastContainer.querySelectorAll('.toast');
            toasts.forEach(toastEl => {
                const toast = bootstrap.Toast.getInstance(toastEl);
                if (toast) {
                    toast.hide();
                }
            });
        }
    }
    
    // é‡æ–°ç»‘å®šæ–‡æ¡£å¡ç‰‡ä¸Šçš„æŒ‰é’®äº‹ä»¶
    function bindDocumentCardEvents() {
        // é‡æ–°ç»‘å®šå¤åˆ¶æŒ‰é’®äº‹ä»¶
        document.querySelectorAll('.copy-btn').forEach(button => {
            button.removeEventListener('click', handleCopyClick);
            button.addEventListener('click', handleCopyClick);
        });
        
        // é‡æ–°ç»‘å®šåˆ é™¤æŒ‰é’®äº‹ä»¶
        document.querySelectorAll('.delete-btn').forEach(button => {
            button.removeEventListener('click', handleDeleteClick);
            button.addEventListener('click', handleDeleteClick);
        });
        
        // é‡æ–°ç»‘å®šé‡å‘½åæŒ‰é’®äº‹ä»¶
        document.querySelectorAll('.edit-title-btn').forEach(button => {
            button.removeEventListener('click', handleRenameClick);
            button.addEventListener('click', handleRenameClick);
        });
        
        // é‡æ–°ç»‘å®šæ·»åŠ æ ‡ç­¾æŒ‰é’®äº‹ä»¶
        document.querySelectorAll('.add-tag-btn').forEach(button => {
            button.removeEventListener('click', handleAddTagClick);
            button.addEventListener('click', handleAddTagClick);
        });
    }
    
    // å¤„ç†å¤åˆ¶æŒ‰é’®ç‚¹å‡»äº‹ä»¶
    function handleCopyClick(event) {
        const docId = this.getAttribute('data-doc-id');
        const docTitle = this.getAttribute('data-doc-title');
        
        // ä¼˜å…ˆå°è¯•ç°ä»£ Clipboard API
        if (navigator.clipboard && navigator.clipboard.writeText) {
            navigator.clipboard.writeText(docId).then(() => {
                showToast(`ğŸ“‹ Document ID for "${docTitle}" copied!`, 'success');
            }).catch(err => {
                console.error('Clipboard API failed, trying fallback...', err);
                fallbackCopyText(docId, docTitle);
            });
        } else {
            // å¦‚æœä¸æ”¯æŒï¼ˆå¦‚é HTTPS ç¯å¢ƒï¼‰ï¼Œç›´æ¥ä½¿ç”¨é™çº§æ–¹æ¡ˆ
            fallbackCopyText(docId, docTitle);
        }
    }
    
    // å¤„ç†åˆ é™¤æŒ‰é’®ç‚¹å‡»äº‹ä»¶
    function handleDeleteClick(event) {
        const docId = this.getAttribute('data-doc-id');
        const docTitle = this.getAttribute('data-doc-title');
        
        if (confirm(`ç¡®å®šè¦åˆ é™¤æ–‡æ¡£"${docTitle}"å—ï¼Ÿæ­¤æ“ä½œæ— æ³•æ’¤é”€ã€‚`)) {
            fetch(`/documents/delete/${docId}`, {
                method: 'DELETE',
                headers: {
                    'Content-Type': 'application/json',
                    'X-Requested-With': 'XMLHttpRequest'
                }
            })
            .then(response => {
                if (response.ok) {
                    window.location.reload();
                    showToast(`æ–‡æ¡£"${docTitle}"åˆ é™¤æˆåŠŸï¼`, 'success');
                } else {
                    showToast(`åˆ é™¤æ–‡æ¡£"${docTitle}"å¤±è´¥ï¼`, 'danger');
                }
            })
            .catch(error => {
                console.error('Error:', error);
                showToast(`åˆ é™¤æ–‡æ¡£"${docTitle}"æ—¶å‘ç”Ÿé”™è¯¯ï¼`, 'danger');
            });
        }
    }
    
    // å¤„ç†é‡å‘½åæŒ‰é’®ç‚¹å‡»äº‹ä»¶
    function handleRenameClick(event) {
        const docId = this.getAttribute('data-doc-id');
        const currentTitle = this.getAttribute('data-doc-title');
        
        const newTitle = prompt('è¯·è¾“å…¥æ–‡æ¡£çš„æ–°æ ‡é¢˜ï¼š', currentTitle);
        
        if (newTitle !== null && newTitle.trim() !== '' && newTitle !== currentTitle) {
            fetch(`/documents/update-title/${docId}`, {
                method: 'POST',
                headers: {
                    'Content-Type': 'application/json',
                    'X-Requested-With': 'XMLHttpRequest'
                },
                body: JSON.stringify({ title: newTitle.trim() })
            })
            .then(response => {
                if (response.ok) {
                    window.location.reload();
                    showToast(`æ–‡æ¡£æ ‡é¢˜å·²æ›´æ–°ä¸º"${newTitle}"ï¼`, 'success');
                } else {
                    showToast('æ›´æ–°æ–‡æ¡£æ ‡é¢˜å¤±è´¥ï¼', 'danger');
                }
            })
            .catch(error => {
                console.error('Error:', error);
                showToast('æ›´æ–°æ–‡æ¡£æ ‡é¢˜æ—¶å‘ç”Ÿé”™è¯¯ï¼', 'danger');
            });
        }
    }
    
    // å¤„ç†æ·»åŠ æ ‡ç­¾æŒ‰é’®ç‚¹å‡»äº‹ä»¶
    function handleAddTagClick(event) {
        const docId = this.getAttribute('data-doc-id');
        const docTitle = this.getAttribute('data-doc-title');
        
        document.getElementById('tagDocumentId').value = docId;
        document.getElementById('tagInput').value = '';
        
        const modal = new bootstrap.Modal(document.getElementById('addTagModal'));
        modal.show();
    }

    // æ˜¾ç¤º Toast æ¶ˆæ¯
    function showToast(message, type = 'info') {
        const toastContainer = document.getElementById('toast-container') || createToastContainer();
        
        // æ ¹æ®ç±»å‹è®¾ç½®èƒŒæ™¯è‰²
        let bgClass = 'text-white bg-info';
        if (type === 'danger') bgClass = 'text-white bg-danger';
        if (type === 'success') bgClass = 'text-white bg-success';

        const toastEl = document.createElement('div');
        toastEl.className = `toast align-items-center border-0 ${bgClass}`;
        toastEl.setAttribute('role', 'alert');
        toastEl.setAttribute('aria-live', 'assertive');
        toastEl.setAttribute('aria-atomic', 'true');

        toastEl.innerHTML = `
            <div class="d-flex">
                <div class="toast-body">
                    ${message}
                </div>
                <button type="button" class="btn-close btn-close-white me-2 m-auto" data-bs-dismiss="toast" aria-label="Close"></button>
            </div>
        `;

        toastContainer.appendChild(toastEl);

        // ä½¿ç”¨ Bootstrap 5 API åˆå§‹åŒ–
        const toast = new bootstrap.Toast(toastEl, { delay: 3000 });
        toast.show();

        // éšè—åä» DOM ç§»é™¤
        toastEl.addEventListener('hidden.bs.toast', function () {
            toastEl.remove();
        });
    }

    // åˆ›å»º Toast å®¹å™¨ï¼ˆå¦‚æœä¸å­˜åœ¨ï¼‰
    function createToastContainer() {
        const container = document.createElement('div');
        container.id = 'toast-container';
        container.className = 'toast-container position-fixed bottom-0 end-0 p-3';
        container.style.zIndex = '1055';
        document.body.appendChild(container);
        return container;
    }
    // åˆ é™¤æ–‡æ¡£åŠŸèƒ½
    document.querySelectorAll('.delete-btn').forEach(button => {
        button.addEventListener('click', function() {
            const docId = this.getAttribute('data-doc-id');
            const docTitle = this.getAttribute('data-doc-title');

            // ç¡®è®¤å¯¹è¯æ¡†
            if (confirm(`Are you sure you want to delete the document "${docTitle}"? This action cannot be undone.`)) {
                // å‘é€åˆ é™¤è¯·æ±‚
                fetch(`/documents/delete/${docId}`, {
                    method: 'DELETE',
                    headers: {
                        'Content-Type': 'application/json',
                        'X-Requested-With': 'XMLHttpRequest'
                    }
                })
                    .then(response => {
                        if (response.ok) {
                            // é‡æ–°åŠ è½½é¡µé¢ä»¥åæ˜ æ›´æ”¹
                            window.location.reload();
                            showToast(`Document "${docTitle}" deleted successfully!`, 'success');
                        } else {
                            showToast(`Failed to delete document "${docTitle}"!`, 'danger');
                        }
                    })
                    .catch(error => {
                        console.error('Error:', error);
                        showToast(`Error deleting document "${docTitle}"!`, 'danger');
                    });
            }
        });
    });

    // ç¼–è¾‘æ–‡æ¡£æ ‡é¢˜åŠŸèƒ½
    document.querySelectorAll('.edit-title-btn').forEach(button => {
        button.addEventListener('click', function() {
            const docId = this.getAttribute('data-doc-id');
            const currentTitle = this.getAttribute('data-doc-title');

            // æç¤ºç”¨æˆ·è¾“å…¥æ–°æ ‡é¢˜
            const newTitle = prompt('Enter new title for the document:', currentTitle);

            // å¦‚æœç”¨æˆ·æ²¡æœ‰å–æ¶ˆå¹¶ä¸”è¾“å…¥äº†æ–°æ ‡é¢˜
            if (newTitle !== null && newTitle.trim() !== '' && newTitle !== currentTitle) {
                // å‘é€æ›´æ–°æ ‡é¢˜è¯·æ±‚
                fetch(`/documents/update-title/${docId}`, {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/json',
                        'X-Requested-With': 'XMLHttpRequest'
                    },
                    body: JSON.stringify({ title: newTitle.trim() })
                })
                    .then(response => {
                        if (response.ok) {
                            // é‡æ–°åŠ è½½é¡µé¢ä»¥åæ˜ æ›´æ”¹
                            window.location.reload();
                            showToast(`Document title updated to "${newTitle}"!`, 'success');
                        } else {
                            showToast(`Failed to update document title!`, 'danger');
                        }
                    })
                    .catch(error => {
                        console.error('Error:', error);
                        showToast(`Error updating document title!`, 'danger');
                    });
            }
        });
    });

</script>
</body>
</html>
}
