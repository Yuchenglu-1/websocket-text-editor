<!DOCTYPE html>
<html xmlns:th="http://www.thymeleaf.org">
<head>
    <title>User Profile</title>
    <meta charset="utf-8">
    <meta name="viewport" content="width=device-width, initial-scale=1">
    <!-- Bootstrap CSSÊ°ÜÊû∂ -->
    <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.3/dist/css/bootstrap.min.css" rel="stylesheet">
    <!-- ÂÖ®Â±ÄÊ†∑ÂºèË°® -->
    <link rel="stylesheet" th:href="@{/style.css}">
    <!-- ‰∏™‰∫∫ËµÑÊñôÈ°µÈù¢‰∏ìÁî®Ê†∑ÂºèË°® -->
    <link rel="stylesheet" th:href="@{/css/profile.css}">
</head>
<body>
    <!-- È°∂ÈÉ®ÂØºËà™Ê†è -->
    <nav class="navbar navbar-expand-lg navbar-dark bg-dark">
        <div class="container-fluid">
            <!-- ÁΩëÁ´ôÂìÅÁâåÈìæÊé• -->
            <a class="navbar-brand" href="/">üìù Code Share</a>
            <div class="navbar-nav ms-auto">
                <div class="nav-item dropdown">
                    <!-- Áî®Êà∑‰∏ãÊãâËèúÂçïËß¶ÂèëÂô® -->
                    <a class="nav-link dropdown-toggle d-flex align-items-center" href="#" id="navbarDropdown" role="button" data-bs-toggle="dropdown" aria-expanded="false">
                        <!-- Â¶ÇÊûúÁî®Êà∑ÊúâÂ§¥ÂÉèÂàôÊòæÁ§∫Â§¥ÂÉèÔºåÂê¶ÂàôÊòæÁ§∫ÈªòËÆ§Â§¥ÂÉè -->
                        <img th:if="${currentUser.avatarUrl}" th:src="${currentUser.avatarUrl}" alt="Avatar" class="rounded-circle me-2" width="32" height="32">
                        <img th:unless="${currentUser.avatarUrl}" src= '/uploads/avatars/default.png' alt="Avatar" class="rounded-circle me-2" width="32" height="32">
                        <span th:text="${currentUser.username}">User</span>
                    </a>
                    <!-- ‰∏ãÊãâËèúÂçïÂÜÖÂÆπ -->
                    <ul class="dropdown-menu dropdown-menu-end" aria-labelledby="navbarDropdown">
                        <li><a class="dropdown-item" href="/profile" id="profileLink">üë§ Profile</a></li>
                        <li><hr class="dropdown-divider"></li>
                        <li><a class="dropdown-item" href="#" id="logoutLink">üö™ Logout</a></li>
                    </ul>
                </div>
            </div>
        </div>
    </nav>

    <div class="container mt-4">
        <h1>üë§ User Profile</h1>
        
        <div class="row">
            <div class="col-md-4">
                <!-- Â§¥ÂÉèÂç°Áâá -->
                <div class="card">
                    <div class="card-header">
                        <h5>Avatar</h5>
                    </div>
                    <div class="card-body text-center">
                        <!-- Â§¥ÂÉèÈ¢ÑËßà -->
                        <img id="avatarPreview" 
                             th:src="${currentUser.avatarUrl ?:  '/uploads/avatars/default.png'}"
                             alt="Avatar" 
                             class="rounded-circle mb-3" 
                             width="128" 
                             height="128">
                        <!-- Â§¥ÂÉè‰∏ä‰º†Ë°®Âçï -->
                        <form id="avatarForm" enctype="multipart/form-data">
                            <div class="mb-3">
                                <input type="file" class="form-control" id="avatarFile" accept="image/*">
                            </div>
                            <button type="submit" class="btn btn-primary">üì§ Upload Avatar</button>
                        </form>
                    </div>
                </div>
                
                <!-- ÈÇÄËØ∑‰ø°ÊÅØÂç°Áâá -->
                <div class="card mt-4">
                    <div class="card-header">
                        <h5>Invitation Info</h5>
                    </div>
                    <div class="card-body">
                        <p>Your invitation UUID:</p>
                        <!-- ÈÇÄËØ∑UUIDÊòæÁ§∫ÂíåÂ§çÂà∂ -->
                        <div class="input-group">
                            <input type="text" class="form-control" id="invitationUuid" th:value="${currentUser.invitationUuid}" readonly>
                            <button class="btn btn-outline-secondary" type="button" id="copyUuidBtn">üìã</button>
                        </div>
                        <div class="mt-2">
                            <small class="text-muted">Share this UUID with others so they can invite you to collaborate on documents.</small>
                        </div>
                    </div>
                </div>
            </div>
            
            <div class="col-md-8">
                <!-- ‰∏™‰∫∫‰ø°ÊÅØÂç°Áâá -->
                <div class="card">
                    <div class="card-header">
                        <h5>Profile Information</h5>
                    </div>
                    <div class="card-body">
                        <div id="profileInfo">
                            <!-- Áî®Êà∑‰ø°ÊÅØÂ∞ÜÈÄöËøáJavaScriptÂä†ËΩΩ -->
                        </div>
                        
                        <!-- ‰∏™‰∫∫‰ø°ÊÅØÁºñËæëË°®Âçï -->
                        <form id="profileForm">
                            <div class="mb-3">
                                <label for="username" class="form-label">Username</label>
                                <input type="text" class="form-control" id="username" name="username" required>
                            </div>
                            
                            <div class="mb-3">
                                <label for="email" class="form-label">Email</label>
                                <input type="email" class="form-control" id="email" name="email" required>
                            </div>
                            
                            <div class="mb-3">
                                <label for="phoneNumber" class="form-label">Phone Number</label>
                                <input type="tel" class="form-control" id="phoneNumber" name="phoneNumber">
                            </div>
                            
                            <button type="submit" class="btn btn-primary">üíæ Save Changes</button>
                        </form>
                    </div>
                </div>
            </div>
        </div>
    </div>

    <!-- ToastÊ∂àÊÅØÂÆπÂô® -->
    <div id="toast-container"></div>

    <!-- Bootstrap JavaScriptÂ∫ì -->
    <script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.3/dist/js/bootstrap.bundle.min.js"></script>
    <script th:inline="javascript">
        /*<![CDATA[*/
        // Á°Æ‰øùBootstrap‰∏ãÊãâËèúÂçïÊ≠£Â∏∏Â∑•‰Ωú
        document.addEventListener('DOMContentLoaded', function() {
            var dropdownElementList = [].slice.call(document.querySelectorAll('[data-bs-toggle="dropdown"]'));
            dropdownElementList.map(function(dropdownToggleEl) {
                return new bootstrap.Dropdown(dropdownToggleEl);
            });
            
            // Â§ÑÁêÜProfileÈìæÊé•ÁÇπÂáª‰∫ã‰ª∂Ôºà‰ªÖÂú®ÂÖÉÁ¥†Â≠òÂú®Êó∂Ê∑ªÂä†ÁõëÂê¨Âô®Ôºâ
            var profileLink = document.getElementById('profileLink');
            if (profileLink) {
                profileLink.addEventListener('click', function(e) {
                    e.preventDefault();
                    window.location.href = '/profile';
                });
            }
            
            // Â§ÑÁêÜLogoutÈìæÊé•ÁÇπÂáª‰∫ã‰ª∂Ôºà‰ªÖÂú®ÂÖÉÁ¥†Â≠òÂú®Êó∂Ê∑ªÂä†ÁõëÂê¨Âô®Ôºâ
            var logoutLink = document.getElementById('logoutLink');
            if (logoutLink) {
                logoutLink.addEventListener('click', function(e) {
                    e.preventDefault();
                    performLogout();
                });
            }
        });
        
        // ÊâßË°åÁôªÂá∫Êìç‰Ωú
        function performLogout() {
            fetch('/api/auth/logout', {
                method: 'POST',
                headers: {
                    'Content-Type': 'application/json'
                }
            })
            .then(response => {
                if (response.ok) {
                    // ÁôªÂá∫ÊàêÂäüÔºåÈáçÂÆöÂêëÂà∞ÁôªÂΩïÈ°µÈù¢
                    window.location.href = '/login?logout';
                } else {
                    console.error('Logout failed');
                    // Âç≥‰ΩøÂ§±Ë¥•‰πüÈáçÂÆöÂêëÂà∞ÁôªÂΩïÈ°µÈù¢
                    window.location.href = '/login?logout';
                }
            })
            .catch(error => {
                console.error('Logout error:', error);
                // Âç≥‰ΩøÂá∫Èîô‰πüÈáçÂÆöÂêëÂà∞ÁôªÂΩïÈ°µÈù¢
                window.location.href = '/login?logout';
            });
        }
        
        const currentUsername = /*[[${currentUser.username}]]*/ 'user';
        const invitationUuid = /*[[${currentUser.invitationUuid}]]*/ 'uuid';
        /*]]>*/
        
        // È°µÈù¢Âä†ËΩΩÊó∂Ëé∑ÂèñÁî®Êà∑‰ø°ÊÅØ
        document.addEventListener('DOMContentLoaded', function() {
            loadUserProfile();
        });
        
        // Âä†ËΩΩÁî®Êà∑‰∏™‰∫∫ËµÑÊñô
        async function loadUserProfile() {
            try {
                const response = await fetch('/api/profile');
                
                if (response.ok) {
                    const user = await response.json();
                    document.getElementById('username').value = user.username || '';
                    document.getElementById('email').value = user.email || '';
                    document.getElementById('phoneNumber').value = user.phoneNumber || '';
                    
                    // ÊòæÁ§∫Áî®Êà∑Âü∫Êú¨‰ø°ÊÅØÔºàÁßªÈô§roleÂ≠óÊÆµÔºâ
                    document.getElementById('profileInfo').innerHTML = `
                        <div class="alert alert-info">
                            <strong>Username:</strong> ${user.username}<br>
                            <!-- ÁßªÈô§roleÂ≠óÊÆµÊòæÁ§∫ -->
                        </div>
                    `;
                    
                    // Â¶ÇÊûúÊúâÂ§¥ÂÉèURLÔºåÂàôÊòæÁ§∫Â§¥ÂÉè
                    if (user.avatarUrl) {
                        document.getElementById('avatarPreview').src = user.avatarUrl;
                    }
                } else {
                    alert('Failed to load user profile');
                }
            } catch (error) {
                console.error('Error loading profile:', error);
                alert('Error loading profile');
            }
        }
        
        // Êõ¥Êñ∞Áî®Êà∑ËµÑÊñô
        document.getElementById('profileForm').addEventListener('submit', async function(e) {
            e.preventDefault();
            
            const formData = new FormData(this);
            
            try {
                const response = await fetch('/api/profile', {
                    method: 'PUT',
                    body: formData
                });
                
                if (response.ok) {
                    showToast('Profile updated successfully! ‚úì');
                    loadUserProfile(); // ÈáçÊñ∞Âä†ËΩΩÁî®Êà∑‰ø°ÊÅØ
                } else {
                    const errorText = await response.text();
                    throw new Error(errorText || 'Failed to update profile');
                }
            } catch (err) {
                console.error('Update error:', err);
                showToast('Failed to update profile! ‚ùå');
            }
        });
        
        // ‰∏ä‰º†Â§¥ÂÉè
        document.getElementById('avatarForm').addEventListener('submit', async function(e) {
            e.preventDefault();
            
            const fileInput = document.getElementById('avatarFile');
            if (!fileInput.files.length) {
                showToast('Please select an image file!');
                return;
            }
            
            const formData = new FormData();
            formData.append('avatar', fileInput.files[0]);
            
            try {
                const response = await fetch('/api/profile/avatar', {
                    method: 'POST',
                    body: formData
                });
                
                if (response.ok) {
                    const result = await response.json();
                    document.getElementById('avatarPreview').src = result.avatarUrl;
                    showToast('Avatar uploaded successfully! ‚úì');
                } else {
                    const errorText = await response.text();
                    throw new Error(errorText || 'Failed to upload avatar');
                }
            } catch (err) {
                console.error('Upload error:', err);
                showToast('Failed to upload avatar! ‚ùå');
            }
        });
        
        // Â§çÂà∂ÈÇÄËØ∑UUID
        document.getElementById('copyUuidBtn').addEventListener('click', function() {
            const uuidInput = document.getElementById('invitationUuid');
            uuidInput.select();
            document.execCommand('copy');
            showToast('Invitation UUID copied to clipboard! ‚úì');
        });
        
        // ToastÊ∂àÊÅØÊòæÁ§∫
        function showToast(message) {
            const toastContainer = document.getElementById('toast-container');
            const toast = document.createElement('div');
            toast.className = 'toast show';
            toast.innerHTML = `
                <div class="toast-body">
                    ${message}
                </div>
            `;
            toastContainer.appendChild(toast);
            
            // 3ÁßíÂêéËá™Âä®ÁßªÈô§
            setTimeout(() => {
                toast.remove();
            }, 3000);
        }
    </script>
</body>
</html>