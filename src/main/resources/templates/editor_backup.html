<!DOCTYPE html>
<html xmlns:th="http://www.thymeleaf.org">
<head>
    <title>Code Share Editor</title>
    <meta charset="utf-8">
    <meta name="viewport" content="width=device-width, initial-scale=1">
    <meta name="_csrf" th:if="${_csrf}" th:content="${_csrf.token}"/>
    <meta name="_csrf_header" th:if="${_csrf}" th:content="${_csrf.headerName}"/>
    
    <!-- Monaco Editor -->
    <link rel="stylesheet" data-name="vs/editor/editor.main" href="https://cdn.jsdelivr.net/npm/monaco-editor@latest/min/vs/editor/editor.main.css">
    <link rel="stylesheet" th:href="@{/style.css}">
    <link rel="stylesheet" th:href="@{/css/editor.css}">
    
    <!-- æ·»åŠ SockJSå’ŒSTOMPåº“ -->
    <script src="https://cdn.jsdelivr.net/npm/sockjs-client@1/dist/sockjs.min.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/stompjs@2/lib/stomp.min.js"></script>
    
    <style>
        /* Removed message history panel styles */
    </style>
    
    <script th:inline="javascript">
        /*<![CDATA[*/
        // ä»URLè·¯å¾„ä¸­æå–æ–‡æ¡£IDçš„è¾…åŠ©å‡½æ•°
        function getDocIdFromUrl() {
            const pathParts = window.location.pathname.split('/');
            if (pathParts.length >= 3 && pathParts[1] === 'editor') {
                return pathParts[2];
            }
            return null;
        }
        /*]]>*/
    </script>
</head>
<body>
    <div class="editor-header">
        <div class="container-fluid">
            <div class="d-flex justify-content-between align-items-center">
                <div class="d-flex align-items-center">
                    <a href="/" class="btn btn-sm btn-outline-secondary me-2">â† Dashboard</a>
                    <h1 class="h5 mb-0">ğŸ“ <span th:text="${document.title ?: 'Untitled Document'}">Document Title</span></h1>
                </div>
                
                <div class="d-flex align-items-center">
                    <!-- è¯­è¨€é€‰æ‹©å™¨ -->
                    <select class="form-select form-select-sm me-2" id="language-selector" th:value="${document.language ?: 'javascript'}">
                        <option value="javascript">JavaScript</option>
                        <option value="typescript">TypeScript</option>
                        <option value="html">HTML</option>
                        <option value="css">CSS</option>
                        <option value="java">Java</option>
                        <option value="python">Python</option>
                        <option value="cpp">C++</option>
                        <option value="csharp">C#</option>
                        <option value="php">PHP</option>
                        <option value="sql">SQL</option>
                        <option value="plaintext">Plaintext</option>
                        <option value="json">JSON</option>
                        <option value="xml">XML</option>
                    </select>
                    
                    <!-- è¯„è®ºå’Œä»»åŠ¡æŒ‰é’® -->
                    <a href="/tasks" class="btn btn-sm btn-outline-success me-2" id="tasks-btn" th:href="@{/tasks}">
                        <i class="fas fa-comments me-1"></i>è¯„è®º/ä»»åŠ¡
                    </a>
                    
                    <!-- åä½œåŠŸèƒ½æŒ‰é’® -->
                    <button id="collaboration-btn" class="btn btn-sm btn-info me-2" th:if="${userPermission.name() == 'OWNER'}">
                        ğŸ‘¥ Collaborate
                    </button>
                    
                    <!-- ä¿å­˜æŒ‰é’® -->
                    <button id="save-btn" class="btn btn-sm btn-success me-2">
                        ğŸ’¾ Save
                    </button>
                    
                    <!-- é€šçŸ¥æŒ‰é’® -->
                    <div class="notification-container">
                        <button id="notification-btn" class="btn btn-sm btn-outline-primary">
                            <i class="fas fa-bell"></i> ğŸ””
                        </button>
                        <span id="notification-badge" class="notification-badge" style="display: none;">0</span>
                    </div>
                    
                    <!-- è¿æ¥çŠ¶æ€æŒ‡ç¤ºå™¨ -->
                    <div class="connection-status-container">
                        <span class="connection-label">Connection:</span>
                        <span class="connection-indicator disconnected">
                            <span class="status-dot"></span>
                            <span class="connection-status">disconnected</span>
                        </span>
                    </div>
                </div>
            </div>
        </div>
    </div>

    <!-- é€šçŸ¥æ¨¡å— -->
    <div id="notification-panel" class="notification-panel">
        <div class="notification-header">
            <h6>é€šçŸ¥</h6>
            <button id="clear-notifications" class="btn btn-sm btn-outline-secondary">æ¸…é™¤</button>
        </div>
        <div id="notifications-container" class="notifications-container">
            <!-- é€šçŸ¥å†…å®¹å°†é€šè¿‡JavaScriptåŠ¨æ€æ·»åŠ  -->
        </div>
    </div>

    <!-- åä½œæ¨¡æ€æ¡† -->
    <div class="modal fade" id="collaborationModal" tabindex="-1" aria-labelledby="collaborationModalLabel" aria-hidden="true" style="display: none;">
        <div class="modal-dialog modal-lg">
            <div class="modal-content">
                <div class="modal-header">
                    <h5 class="modal-title" id="collaborationModalLabel">ğŸ‘¥ Document Collaboration</h5>
                    <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Close">
                        <span aria-hidden="true">Close</span>
                    </button>
                </div>
                <div class="modal-body">
                    <div class="mb-4">
                        <h6>Invite Users</h6>
                        <div class="input-group mt-3">
                            <input type="text" class="form-control" id="invite-uuid" placeholder="Enter invitation UUID...">
                            <select class="form-select form-select-sm permission-select-uuid" id="permission-select-uuid">
                                <option value="EDITOR">Editor</option>
                                <option value="VIEWER">Viewer</option>
                            </select>
                            <button class="btn btn-primary" type="button" id="invite-by-uuid-btn">Invite</button>
                        </div>
                    </div>
                    
                    <div class="mb-4">
                        <h6>Document Collaborators</h6>
                        <div id="collaborators-list">
                            <!-- åä½œè€…åˆ—è¡¨å°†é€šè¿‡JavaScriptåŠ è½½ -->
                        </div>
                    </div>
                </div>
            </div>
        </div>
    </div>

    <div id="editor-container" th:class="${canEdit ? '' : 'read-only'}"></div>
    
    <div id="cursor-overlay"></div>
    
    <div id="toast-container"></div>
    <!-- æ·»åŠ Bootstrap JS -->
    <script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.3/dist/js/bootstrap.bundle.min.js"></script>
    <!-- Monaco Editor -->
    <script src="https://cdn.jsdelivr.net/npm/monaco-editor@latest/min/vs/loader.js"></script>
    <script type="module">
        /*<![CDATA[*/
        const ywsUrl = /*[[${ywsUrl}]]*/ 'ws://localhost:1234';
        // ä½¿ç”¨ä»URLè·å–çš„æ–‡æ¡£IDï¼Œå¦‚æœè·å–ä¸åˆ°åˆ™ä½¿ç”¨Thymeleafæä¾›çš„ID
        const docIdFromUrl = getDocIdFromUrl();
        const docId = docIdFromUrl || /*[[${document.uniqueId}]]*/ 'default-room';
        const currentUsername = /*[[${currentUser.username}]]*/ 'Anonymous';
        const documentContent = /*[[${document.content}]]*/ '';
        const canEdit = /*[[${canEdit}]]*/ true;
        // æ£€æŸ¥å½“å‰æ˜¯å¦æ˜¯æ–°æ–‡æ¡£
        let isNewDocument = docId === 'default-room';
        /*]]>*/

        import * as Y from 'https://esm.sh/yjs@14.0.0-6';
        import { WebsocketProvider } from 'https://esm.sh/@y/websocket@4.0.0-1?alias=yjs:https://esm.sh/yjs@14.0.0-6';

        // æ·»åŠ SockJSå’ŒSTOMPåº“ç”¨äºWebSocketé€šçŸ¥
        let stompClient = null;
        let notificationCount = 0;

        let monacoEditor;
        let provider;
        let awareness;
        let isUpdatingFromY = false;

        // Initialize Monaco Editor
        require.config({ paths: { vs: 'https://cdn.jsdelivr.net/npm/monaco-editor@latest/min/vs' } });
        require(['vs/editor/editor.main'], function () {
            // Configure Monaco
            monaco.editor.defineTheme('code-share-theme', {
                base: 'vs',
                inherit: true,
                rules: [],
                colors: {
                    'editor.background': '#ffffff',
                    'editor.foreground': '#333333',
                    'editorLineNumber.foreground': '#999999',
                    'editor.selectionBackground': '#add6ff',
                    'editor.inactiveSelectionBackground': '#e5ebf1'
                }
            });

            // Detect if on mobile device
            const isMobile = /Android|webOS|iPhone|iPad|iPod|BlackBerry|IEMobile|Opera Mini/i.test(navigator.userAgent);

            // Get initial language from selector or default to javascript
            const initialLanguage = document.getElementById('language-selector')?.value || 'javascript';

            monacoEditor = monaco.editor.create(document.getElementById('editor-container'), {
                value: documentContent || '// Welcome to Code Share!\n// Start typing your code here...\n\n',
                language: initialLanguage,
                theme: 'code-share-theme',
                fontSize: isMobile ? 16 : 14, // Larger font on mobile to prevent zoom
                fontFamily: "'Fira Code', 'Cascadia Code', 'JetBrains Mono', 'Source Code Pro', monospace",
                lineNumbers: isMobile ? 'off' : 'on', // Hide line numbers on mobile for more space
                minimap: {enabled: false},
                scrollBeyondLastLine: false,
                automaticLayout: true,
                wordWrap: 'on',
                folding: !isMobile, // Disable folding on mobile
                renderLineHighlight: 'all',
                selectOnLineNumbers: !isMobile,
                roundedSelection: false,
                readOnly: !canEdit, // æ ¹æ®ç”¨æˆ·æƒé™è®¾ç½®ç¼–è¾‘å™¨æ˜¯å¦åªè¯»
                cursorStyle: 'line',
                cursorBlinking: 'blink',
                tabSize: 4,
                insertSpaces: true,
                // Mobile-specific options
                mouseWheelZoom: false, // Disable zoom with mouse wheel
                contextmenu: !isMobile, // Disable context menu on mobile
                quickSuggestions: !isMobile, // Disable suggestions on mobile to prevent UI interference
                suggestOnTriggerCharacters: !isMobile,
                acceptSuggestionOnEnter: 'off', // Prevent accidental suggestion acceptance
                parameterHints: {enabled: !isMobile},
                hover: {enabled: !isMobile},
                links: false, // Disable links on mobile
                colorDecorators: !isMobile,
                lightbulb: {enabled: false}, // Disable lightbulb on mobile
                overviewRulerBorder: false,
                hideCursorInOverviewRuler: true,
                scrollbar: {
                    useShadows: false,
                    verticalHasArrows: false,
                    horizontalHasArrows: false,
                    vertical: isMobile ? 'hidden' : 'auto',
                    horizontal: isMobile ? 'hidden' : 'auto'
                }
            });

            initializeCollaboration();

            // ç¡®ä¿åœ¨ç¼–è¾‘å™¨åˆå§‹åŒ–å®Œæˆåæ·»åŠ äº‹ä»¶ç›‘å¬å™¨
            function attachEventListeners() {
                // ä¿å­˜åŠŸèƒ½
                const saveBtn = document.getElementById('save-btn');
                if (saveBtn) {
                    saveBtn.addEventListener('click', async function () {
                        // æ£€æŸ¥ç”¨æˆ·æ˜¯å¦æœ‰ç¼–è¾‘æƒé™
                        if (!canEdit) {
                            showToast('You do not have permission to save this document.');
                            return;
                        }

                        try {
                            const content = monacoEditor.getValue();
                            const language = document.getElementById('language-selector').value;
                            const titleElement = document.querySelector('h1 span');
                            const title = titleElement ? titleElement.textContent : 'Untitled Document';

                            // å¯¹äºæ–°æ–‡æ¡£ï¼ˆIDä¸º'default-room'ï¼‰ï¼Œä¸æ‰§è¡Œä»»ä½•æ“ä½œ
                            if (docId === 'default-room') {
                                showToast('Please create a new document first using the "New Document" button on the dashboard.');
                                return;
                            }

                            const response = await fetch(`/documents/update-title/${docId}`, {
                                method: 'POST',
                                headers: {
                                    'Content-Type': 'application/json',
                                    'X-CSRF-TOKEN': document.querySelector('meta[name="_csrf"]')?.getAttribute('content') || ''
                                },
                                body: JSON.stringify({title: title}) // ä½¿ç”¨å½“å‰æ ‡é¢˜è€Œä¸æ˜¯æ–°æ ‡é¢˜
                            });

                            if (response.ok) {

                                // ä¿å­˜æ–‡æ¡£å†…å®¹
                                const saveResponse = await fetch('/documents/save', {
                                    method: 'POST',
                                    headers: {
                                        'Content-Type': 'application/x-www-form-urlencoded',
                                        'X-CSRF-TOKEN': document.querySelector('meta[name="_csrf"]')?.getAttribute('content') || ''
                                    },
                                    body: new URLSearchParams({
                                        documentId: docId,
                                        content: content,
                                        language: language,
                                        title: title // ä½¿ç”¨å½“å‰æ ‡é¢˜è€Œä¸æ˜¯æ–°æ ‡é¢˜
                                    })
                                });

                                if (saveResponse.ok) {
                                    showToast('Document saved successfully!');
                                } else {
                                    showToast('Failed to save document content.');
                                }
                            } else {
                                showToast('Failed to update document title.');
                            }
                        } catch (error) {
                            console.error('Save error:', error);
                            showToast('An error occurred while saving the document.');
                        }
                    });
                }

                // è¯„è®ºå’Œä»»åŠ¡æŒ‰é’®åŠŸèƒ½
                const tasksBtn = document.getElementById('tasks-btn');
                if (tasksBtn) {
                    tasksBtn.addEventListener('click', function (e) {
                        e.preventDefault();
                        // è·³è½¬åˆ°ä»»åŠ¡é¡µé¢å¹¶ä¼ é€’æ–‡æ¡£IDå’Œç”¨æˆ·å
                        window.location.href = `/tasks?docId=${docId}&username=${encodeURIComponent(currentUsername)}`;
                    });
                }

                // åä½œåŠŸèƒ½
                const collaborationBtn = document.getElementById('collaboration-btn');
                if (collaborationBtn) {
                    collaborationBtn.addEventListener('click', function () {
                        const modal = new bootstrap.Modal(document.getElementById('collaborationModal'));
                        modal.show();
                        loadCollaborators();
                    });
                }

                // è¯­è¨€é€‰æ‹©å™¨
                const languageSelector = document.getElementById('language-selector');
                if (languageSelector) {
                    languageSelector.addEventListener('change', function () {
                        const newLanguage = this.value;
                        monaco.editor.setModelLanguage(monacoEditor.getModel(), newLanguage);
                    });
                }

                // æ·»åŠ é€šçŸ¥ç›¸å…³çš„äº‹ä»¶ç›‘å¬å™¨
                const notificationBtn = document.getElementById('notification-btn');
                if (notificationBtn) {
                    notificationBtn.addEventListener('click', toggleNotificationPanel);
                }

                const clearNotificationsBtn = document.getElementById('clear-notifications');
                if (clearNotificationsBtn) {
                    clearNotificationsBtn.addEventListener('click', clearNotifications);
                }

                // ç‚¹å‡»é¢æ¿å¤–å…³é—­é€šçŸ¥é¢æ¿
                document.addEventListener('click', function (e) {
                    const notificationPanel = document.getElementById('notification-panel');
                    const notificationBtn = document.getElementById('notification-btn');

                    if (notificationPanel && notificationBtn &&
                        notificationPanel.classList.contains('visible') &&
                        !notificationPanel.contains(e.target) &&
                        !notificationBtn.closest('.notification-container').contains(e.target)) {
                        notificationPanel.classList.remove('visible');
                    }
                });
            }

            // åœ¨DOMåŠ è½½å®Œæˆåç»‘å®šäº‹ä»¶ç›‘å¬å™¨ (è¿™éƒ¨åˆ†ç°åœ¨åœ¨å‡½æ•°å®šä¹‰ä¹‹å¤–)
            if (document.readyState === 'loading') {
                document.addEventListener('DOMContentLoaded', attachEventListeners);
            } else {
                attachEventListeners();
            }

            // ä¿®æ”¹æƒé™ä¸‹æ‹‰èœå•äº‹ä»¶ç›‘å¬å™¨
            document.addEventListener('change', function (e) {
                if (e.target.classList.contains('permission-select')) {
                    const userId = e.target.dataset.userId;
                    const newPermission = e.target.value;
                    updateCollaboratorPermission(userId, newPermission);
                }
            });

            // ç§»é™¤åä½œè€…æŒ‰é’®äº‹ä»¶ç›‘å¬å™¨
            document.addEventListener('click', function (e) {
                if (e.target.classList.contains('remove-collaborator')) {
                    const userId = e.target.dataset.userId;
                    removeCollaborator(userId);
                }
            });

            // åˆå§‹åŒ–åä½œåŠŸèƒ½
            function initializeCollaboration() {
                // é‡æ–°è·å–initialLanguageï¼Œå› ä¸ºåœ¨è¯¥å‡½æ•°ä½œç”¨åŸŸå†…æ— æ³•è®¿é—®å¤–éƒ¨å®šä¹‰çš„å˜é‡
                const initialLanguage = document.getElementById('language-selector')?.value || 'javascript';

                const ydoc = new Y.Doc();
                provider = new WebsocketProvider(ywsUrl, docId, ydoc);
                const ytext = ydoc.getText('monaco');
                awareness = provider.awareness;
                const localClientId = awareness.clientID || ydoc.clientID;

                // Set user awareness
                const localUser = {
                    name: currentUsername,
                    color: colorFromId(localClientId),
                    language: initialLanguage
                };
                awareness.setLocalState({user: localUser, cursor: null});

                // Y.js to Monaco synchronization
                ytext.observe(event => {
                    if (isUpdatingFromY) return;

                    const content = ytext.toString();
                    if (monacoEditor.getValue() !== content) {
                        isUpdatingFromY = true;
                        monacoEditor.setValue(content);
                        isUpdatingFromY = false;
                    }
                });

                // Monaco to Y.js synchronization
                monacoEditor.onDidChangeModelContent((event) => {
                    if (isUpdatingFromY) return;

                    ydoc.transact(() => {
                        const changes = event.changes.sort((a, b) => b.rangeOffset - a.rangeOffset);

                        for (const change of changes) {
                            if (change.rangeLength > 0) {
                                ytext.delete(change.rangeOffset, change.rangeLength);
                            }
                            if (change.text.length > 0) {
                                ytext.insert(change.rangeOffset, change.text);
                            }
                        }
                    }, 'monaco');
                });

                // Handle connection status
                const connectionStatusEl = document.querySelector('.connection-status');
                const connectionIndicator = document.querySelector('.connection-indicator');
                provider.on('status', event => {
                    connectionStatusEl.textContent = event.status;
                    connectionIndicator.className = 'connection-indicator ' + event.status;
                });

                // Set initial content on sync
                provider.on('sync', isSynced => {
                    if (isSynced) {
                        const content = ytext.toString();
                        // åªæœ‰å½“ç¼–è¾‘å™¨å†…å®¹ä¸ºç©ºæˆ–è€…ä¸Y.jså†…å®¹ä¸åŒæ—¶æ‰æ›´æ–°
                        if ((monacoEditor.getValue().trim() === '' || monacoEditor.getValue() !== content) && content.trim() !== '') {
                            isUpdatingFromY = true;
                            monacoEditor.setValue(content);
                            isUpdatingFromY = false;
                        }
                    }
                });

                // å¦‚æœæˆ‘ä»¬æœ‰æ•°æ®åº“å†…å®¹ä¸”YTextä¸ºç©ºï¼Œåˆ™ç”¨æ•°æ®åº“å†…å®¹åˆå§‹åŒ–Y.jsæ–‡æ¡£
                // è¿™ä¸ªé€»è¾‘éœ€è¦åœ¨observeäº‹ä»¶ç»‘å®šä¹‹åæ‰§è¡Œï¼Œä»¥ç¡®ä¿å†…å®¹æ­£ç¡®åŒæ­¥
                setTimeout(() => {
                    if (documentContent && ytext.toString().length === 0) {
                        ytext.insert(0, documentContent);
                    }
                }, 100);

                setupCursorTracking();

                // è¿æ¥é€šçŸ¥WebSocket
                connectNotificationWebSocket();
            }

            // åä½œåŠŸèƒ½
            document.getElementById('collaboration-btn')?.addEventListener('click', function () {
                const modalElement = document.getElementById('collaborationModal');
                let modal = bootstrap.Modal.getInstance(modalElement);
                if (!modal) {
                    modal = new bootstrap.Modal(modalElement, {
                        backdrop: true,
                        keyboard: true
                    });
                }
                modal.show();
                loadCollaborators();
            });

            // é‚€è¯·ç”¨æˆ·ï¼ˆé€šè¿‡UUIDï¼‰
            async function inviteUserByUuid() {
                const invitationUuid = document.getElementById('invite-uuid').value.trim();
                const permissionLevel = document.getElementById('permission-select-uuid').value;

                if (!invitationUuid) {
                    showToast('Please enter an invitation UUID!');
                    return;
                }

                try {
                    const response = await fetch(`/api/documents/${docId}/invite-by-uuid`, {
                        method: 'POST',
                        headers: {
                            'Content-Type': 'application/x-www-form-urlencoded'
                        },
                        body: new URLSearchParams({
                            'invitationUuid': invitationUuid,
                            'permissionLevel': permissionLevel
                        })
                    });

                    if (response.ok) {
                        showToast('User invited successfully!');
                        document.getElementById('invite-uuid').value = '';
                        loadCollaborators(); // é‡æ–°åŠ è½½åä½œè€…åˆ—è¡¨
                    } else {
                        const errorText = await response.text();
                        showToast('Failed to invite user: ' + errorText);
                    }
                } catch (err) {
                    console.error('Invite error:', err);
                    showToast('Failed to invite user!');
                }
            }

            // æ·»åŠ é‚€è¯·æŒ‰é’®äº‹ä»¶ç›‘å¬å™¨
            document.getElementById('invite-by-uuid-btn').addEventListener('click', inviteUserByUuid);

            // æ·»åŠ å›è½¦é”®ç›‘å¬å™¨
            document.getElementById('invite-uuid').addEventListener('keypress', function (e) {
                if (e.key === 'Enter') {
                    inviteUserByUuid();
                }
            });

            // åŠ è½½åä½œè€…åˆ—è¡¨
            async function loadCollaborators() {
                try {
                    const response = await fetch(`/api/documents/${docId}/collaborators`, {
                        method: 'GET',
                        headers: {
                            'Content-Type': 'application/json'
                        }
                    });

                    if (response.ok) {
                        const collaborators = await response.json();
                        displayCollaborators(collaborators);
                    } else {
                        showToast('Failed to load collaborators!');
                    }
                } catch (err) {
                    console.error('Load collaborators error:', err);
                    showToast('Failed to load collaborators!');
                }
            }

            document.querySelectorAll('.permission-select').forEach(select => {
                select.addEventListener('change', function () {
                    const userId = this.getAttribute('data-user-id');
                    const newPermission = this.value;
                    updateCollaboratorPermission(userId, newPermission);
                });
            });
            document.querySelectorAll('.remove-collaborator').forEach(button => {
                button.addEventListener('click', function () {
                    const userId = this.getAttribute('data-user-id');
                    removeCollaborator(userId);
                });
            });

            // æ˜¾ç¤ºåä½œè€…åˆ—è¡¨
            function displayCollaborators(collaborators) {
                const listContainer = document.getElementById('collaborators-list');
                if (collaborators.length === 0) {
                    listContainer.innerHTML = '<div class="alert alert-info">No collaborators yet</div>';
                    return;
                }

                let html = '<div class="list-group">';
                collaborators.forEach(collaborator => {
                    let permissionBadge = '';
                    let actionButtons = '';

                    switch (collaborator.permissionLevel) {
                        case 'OWNER':
                            permissionBadge = '<span class="badge bg-primary">Owner</span>';
                            // å¯¹äºæ‹¥æœ‰è€…ï¼Œä¸æ˜¾ç¤ºç§»é™¤å’Œä¿®æ”¹æƒé™çš„æ§ä»¶
                            actionButtons = '';
                            break;
                        case 'EDITOR':
                            permissionBadge = '<span class="badge bg-success">Editor</span>';
                            actionButtons = `
            <!-- ä¿®æ”¹æƒé™ä¸‹æ‹‰èœå• -->
            <select class="form-select form-select-sm ms-2 permission-select"
                    data-user-id="${collaborator.userId}"
                    style="width: auto;">
                <option value="EDITOR" ${collaborator.permissionLevel === 'EDITOR' ? 'selected' : ''}>Editor</option>
                <option value="VIEWER" ${collaborator.permissionLevel === 'VIEWER' ? 'selected' : ''}>Viewer</option>
            </select>
            <!-- ç§»é™¤åä½œè€…æŒ‰é’® -->
            <button class="btn btn-sm btn-danger ms-2 remove-collaborator"
                    data-user-id="${collaborator.userId}">
                Remove
            </button>
        `;
                            break;
                        case 'VIEWER':
                            permissionBadge = '<span class="badge bg-secondary">Viewer</span>';
                            actionButtons = `
            <!-- ä¿®æ”¹æƒé™ä¸‹æ‹‰èœå• -->
            <select class="form-select form-select-sm ms-2 permission-select"
                    data-user-id="${collaborator.userId}"
                    style="width: auto;">
                <option value="EDITOR" ${collaborator.permissionLevel === 'EDITOR' ? 'selected' : ''}>Editor</option>
                <option value="VIEWER" ${collaborator.permissionLevel === 'VIEWER' ? 'selected' : ''}>Viewer</option>
            </select>
            <!-- ç§»é™¤åä½œè€…æŒ‰é’® -->
            <button class="btn btn-sm btn-danger ms-2 remove-collaborator"
                    data-user-id="${collaborator.userId}">
                Remove
            </button>
        `;
                            break;
                    }

                    html += `
    <div class="list-group-item d-flex justify-content-between align-items-center">
        <div>
            <strong>${collaborator.username}</strong>
        </div>
        <div class="d-flex align-items-center">
            ${permissionBadge}
            ${actionButtons}
        </div>
    </div>
`;
                });
                html += '</div>';

                listContainer.innerHTML = html;
            }

            //æ›´æ–°åä½œè€…æƒé™
            async function updateCollaboratorPermission(userId, permissionLevel) {
                try {
                    // è·å–CSRFä»¤ç‰Œ
                    const csrfToken = document.querySelector('meta[name="_csrf"]')?.getAttribute('content');
                    const csrfHeader = document.querySelector('meta[name="_csrf_header"]')?.getAttribute('content');

                    // æ„å»ºè¯·æ±‚å¤´
                    const headers = {
                        'Content-Type': 'application/json'
                    };

                    // å¦‚æœå­˜åœ¨CSRFä»¤ç‰Œï¼Œåˆ™æ·»åŠ åˆ°è¯·æ±‚å¤´ä¸­
                    if (csrfToken && csrfHeader) {
                        headers[csrfHeader] = csrfToken;
                    }

                    const response = await fetch(`/api/documents/${docId}/collaborators/${userId}/permission`, {
                        method: 'PUT',
                        headers: headers,
                        body: JSON.stringify({permissionLevel: permissionLevel})
                    });

                    if (response.ok) {
                        showToast('Permission updated successfully!');
                        loadCollaborators(); // é‡æ–°åŠ è½½åä½œè€…åˆ—è¡¨
                    } else {
                        const errorMsg = await response.text();
                        showToast('Failed to update permission: ' + errorMsg);
                    }
                } catch (err) {
                    console.error('Update permission error:', err);
                    showToast('Failed to update permission!');
                }
            }

//ç§»é™¤åä½œè€…
            async function removeCollaborator(userId) {
                if (!confirm('Are you sure you want to remove this collaborator?')) {
                    return;
                }

                try {
                    // è·å–CSRFä»¤ç‰Œ
                    const csrfToken = document.querySelector('meta[name="_csrf"]')?.getAttribute('content');
                    const csrfHeader = document.querySelector('meta[name="_csrf_header"]')?.getAttribute('content');

                    // æ„å»ºè¯·æ±‚å¤´
                    const headers = {};

                    // å¦‚æœå­˜åœ¨CSRFä»¤ç‰Œï¼Œåˆ™æ·»åŠ åˆ°è¯·æ±‚å¤´ä¸­
                    if (csrfToken && csrfHeader) {
                        headers[csrfHeader] = csrfToken;
                    }

                    const response = await fetch(`/api/documents/${docId}/collaborators/${userId}`, {
                        method: 'DELETE',
                        headers: headers
                    });

                    if (response.ok) {
                        showToast('Collaborator removed successfully!');
                        loadCollaborators(); // é‡æ–°åŠ è½½åä½œè€…åˆ—è¡¨
                    } else {
                        const errorMsg = await response.text();
                        showToast('Failed to remove collaborator: ' + errorMsg);
                    }
                } catch (err) {
                    console.error('Remove collaborator error:', err);
                    showToast('Failed to remove collaborator!');
                }
            }

            function colorFromId(id) {
                const colors = ['#FF6B6B', '#4ECDC4', '#45B7D1', '#96CEB4', '#FFEAA7', '#DDA0DD', '#FFA07A', '#98FB98'];
                return colors[id % colors.length];
            }

            function setupCursorTracking() {
                const container = document.getElementById('editor-container');
                const overlay = document.getElementById('cursor-overlay');

                // Track mouse movement for cursor awareness
                container.addEventListener('mousemove', (e) => {
                    const rect = container.getBoundingClientRect();
                    const x = (e.clientX - rect.left) / rect.width;
                    const y = (e.clientY - rect.top) / rect.height;
                    awareness.setLocalStateField('cursor', {x, y, t: Date.now()});
                });

                container.addEventListener('mouseleave', () => {
                    awareness.setLocalStateField('cursor', null);
                });

                // Add touch event handling for mobile devices
                container.addEventListener('touchmove', (e) => {
                    e.preventDefault(); // Prevent default touch behavior
                    const rect = container.getBoundingClientRect();
                    const touch = e.touches[0];
                    const x = (touch.clientX - rect.left) / rect.width;
                    const y = (touch.clientY - rect.top) / rect.height;
                    awareness.setLocalStateField('cursor', {x, y, t: Date.now()});
                }, {passive: false});

                container.addEventListener('touchend', () => {
                    awareness.setLocalStateField('cursor', null);
                });

                container.addEventListener('touchstart', (e) => {
                    const rect = container.getBoundingClientRect();
                    const touch = e.touches[0];
                    const x = (touch.clientX - rect.left) / rect.width;
                    const y = (touch.clientY - rect.top) / rect.height;
                    awareness.setLocalStateField('cursor', {x, y, t: Date.now()});
                });

                // Render other users' cursors
                function renderCursors() {
                    const rect = container.getBoundingClientRect();
                    overlay.innerHTML = '';
                    const states = Array.from(awareness.getStates().entries());

                    for (const [clientId, state] of states) {
                        if (!state || clientId === awareness.clientID) continue;
                        const cursor = state.cursor;
                        if (!cursor || typeof cursor.x !== 'number' || typeof cursor.y !== 'number') continue;

                        const user = state.user || {name: `User ${clientId}`, color: colorFromId(clientId)};
                        const x = cursor.x * rect.width;
                        const y = cursor.y * rect.height;

                        const cursorEl = document.createElement('div');
                        cursorEl.style.position = 'absolute';
                        cursorEl.style.left = `${x}px`;
                        cursorEl.style.top = `${y}px`;
                        cursorEl.style.transform = 'translate(-50%, -50%)';
                        cursorEl.style.pointerEvents = 'none';
                        cursorEl.style.zIndex = '1001';

                        const dot = document.createElement('div');
                        dot.style.width = '12px';
                        dot.style.height = '12px';
                        dot.style.borderRadius = '50%';
                        dot.style.background = user.color;
                        dot.style.boxShadow = '0 2px 4px rgba(0,0,0,0.3)';
                        cursorEl.appendChild(dot);

                        const label = document.createElement('div');
                        label.textContent = user.name;
                        label.style.position = 'absolute';
                        label.style.left = '15px';
                        label.style.top = '-8px';
                        label.style.fontSize = '11px';
                        label.style.padding = '2px 8px';
                        label.style.borderRadius = '12px';
                        label.style.color = '#fff';
                        label.style.background = user.color;
                        label.style.boxShadow = '0 2px 4px rgba(0,0,0,0.2)';
                        label.style.fontWeight = '500';
                        label.style.whiteSpace = 'nowrap';
                        cursorEl.appendChild(label);

                        overlay.appendChild(cursorEl);
                    }
                }

                awareness.on('update', renderCursors);
                window.addEventListener('resize', renderCursors);
            }

// Language selector
            document.getElementById('language-selector').addEventListener('change', (e) => {
                const language = e.target.value;
                monaco.editor.setModelLanguage(monacoEditor.getModel(), language);

                // Update user awareness with current language
                if (awareness) {
                    const currentState = awareness.getLocalState();
                    const user = currentState.user || {};
                    user.language = language;
                    awareness.setLocalStateField('user', user);
                }
            });

// Toastæ¶ˆæ¯æ˜¾ç¤º
            function showToast(message) {
                const toastContainer = document.getElementById('toast-container');
                const toast = document.createElement('div');
                toast.className = 'toast show';
                toast.innerHTML = `
        <div class="toast-body">
            ${message}
        </div>
    `;
                toastContainer.appendChild(toast);

                // 3ç§’åè‡ªåŠ¨ç§»é™¤
                setTimeout(() => {
                    toast.remove();
                }, 3000);
            }

// Keyboard shortcuts
            document.addEventListener('keydown', (e) => {
                if (e.ctrlKey || e.metaKey) {
                    switch (e.key) {
                        case 's':
                            e.preventDefault();
                            document.getElementById('save-btn').click();
                            break;
                    }
                }
            });

// åˆå§‹åŒ–WebSocketé€šçŸ¥è¿æ¥
            function connectNotificationWebSocket() {
                const socket = new SockJS('/ws');
                stompClient = Stomp.over(socket);

                stompClient.connect({}, function (frame) {
                    console.log('Connected: ' + frame);

                    // è®¢é˜…å…¬å…±é€šçŸ¥ä¸»é¢˜
                    stompClient.subscribe('/topic/public', function (message) {
                        const notification = JSON.parse(message.body);
                        showNotification(notification);
                    });

                    // è®¢é˜…ç§èŠé€šçŸ¥ä¸»é¢˜
                    stompClient.subscribe('/user/queue/messages', function (message) {
                        const notification = JSON.parse(message.body);
                        showNotification(notification);
                    });

                    // Removed loading message history on connection
                });
            }

// æ˜¾ç¤ºé€šçŸ¥
            function showNotification(notification) {
                // å¢åŠ æœªè¯»é€šçŸ¥è®¡æ•°
                notificationCount++;
                updateNotificationBadge();

                // æ ¹æ®ä¸åŒç±»å‹ç”Ÿæˆé€šçŸ¥æ ‡é¢˜å’Œå†…å®¹
                let title = 'é€šçŸ¥';
                let message = '';

                switch (notification.type) {
                    //æ ¹æ®æ¶ˆæ¯å¼¹å‡ºä¸åŒçš„æ¶ˆæ¯
                    case 'task':
                        if (notification.action && notification.data.title) {
                            message = `æ–°ä»»åŠ¡:${notification.action}ä»»åŠ¡ ${notification.data.title}`;
                        } else {
                            message = 'æ‚¨æœ‰ä¸€ä¸ªæ–°ä»»åŠ¡';
                        }
                        break;
                    case 'comment':
                        title = 'æ–°è¯„è®º';
                        if (notification.data && notification.data.content) {
                            message = notification.data.content.substring(0, 50) + (notification.data.content.length > 50 ? '...' : '');
                        } else {
                            message = 'æ‚¨æœ‰ä¸€æ¡è¯„è®º';
                        }
                        break;
                    case 'document':
                        title = 'æ–‡æ¡£æ›´æ–°';
                        if (notification.data && notification.data.title) {
                            message = `æ–‡æ¡£ "${notification.data.title}" å·²æ›´æ–°`;
                        } else {
                            message = 'æ–‡æ¡£æœ‰æ›´æ–°';
                        }
                        break;
                    default:
                        title = notification.title || 'é€šçŸ¥';
                        message = notification.message || notification.content || 'æ‚¨æœ‰ä¸€æ¡æ–°é€šçŸ¥';
                }

                // åˆ›å»ºé€šçŸ¥é¡¹
                const notificationItem = document.createElement('div');
                notificationItem.className = 'notification-item unread';
                notificationItem.innerHTML = `
        <div class="notification-title">${title}</div>
        <div class="notification-message">${message}</div>
        <div class="notification-time">${new Date().toLocaleTimeString()}</div>
    `;

                // æ·»åŠ ç‚¹å‡»äº‹ä»¶
                notificationItem.addEventListener('click', function () {
                    // æ ‡è®°ä¸ºå·²è¯»
                    this.classList.remove('unread');
                    // å‡å°‘æœªè¯»è®¡æ•°
                    if (notificationCount > 0) {
                        notificationCount--;
                        updateNotificationBadge();
                    }

                    // å¦‚æœé€šçŸ¥åŒ…å«åŠ¨ä½œï¼Œæ‰§è¡Œç›¸åº”æ“ä½œ
                    if (notification.action) {
                        handleNotificationAction(notification);
                    }
                });

                // å°†é€šçŸ¥æ·»åŠ åˆ°å®¹å™¨é¡¶éƒ¨
                const container = document.getElementById('notifications-container');
                container.insertBefore(notificationItem, container.firstChild);
            }

// æ›´æ–°é€šçŸ¥å¾½ç« 
            function updateNotificationBadge() {
                const badge = document.getElementById('notification-badge');
                if (notificationCount > 0) {
                    badge.textContent = notificationCount;
                    badge.style.display = 'flex';
                } else {
                    badge.style.display = 'none';
                }
            }

// å¤„ç†é€šçŸ¥åŠ¨ä½œ
            function handleNotificationAction(notification) {
                // æ ¹æ®ä¸åŒç±»å‹æ˜¾ç¤ºä¸åŒçš„æ¶ˆæ¯å†…å®¹
                let message = '';
                switch (notification.type) {
                    case 'task':
                        // å¯¹äºä»»åŠ¡ç±»å‹ï¼Œæ˜¾ç¤ºä»»åŠ¡ç›¸å…³ä¿¡æ¯ TODO
                        if (notification.action && notification.data.title) {
                            message = `æ–°ä»»åŠ¡:${notification.action}ä»»åŠ¡ ${notification.data.title}`;
                        } else {
                            message = 'æ‚¨æœ‰ä¸€ä¸ªæ–°ä»»åŠ¡';
                        }
                        break;
                    case 'comment':
                        // å¯¹äºè¯„è®ºç±»å‹ï¼Œæ˜¾ç¤ºè¯„è®ºç›¸å…³ä¿¡æ¯ TODO
                        if (notification.data && notification.data.content) {
                            message = `æ–°è¯„è®º: ${notification.data.content.substring(0, 30)}${notification.data.content.length > 30 ? '...' : ''}`;
                        } else {
                            message = 'æ‚¨æœ‰ä¸€æ¡è¯„è®º';
                        }
                        break;
                    default:
                        // é»˜è®¤æƒ…å†µä¸‹æ˜¾ç¤ºæ¶ˆæ¯å†…å®¹æˆ–é€šç”¨æç¤º
                        message = notification.message || notification.content || 'æ‚¨æœ‰ä¸€æ¡æ–°é€šçŸ¥';
                }

                // æ˜¾ç¤ºtoastæ¶ˆæ¯
                showToast(message);
            }

// Removed message history loading and display functionality

// æ¸…é™¤æ‰€æœ‰é€šçŸ¥
            function clearNotifications() {
                const container = document.getElementById('notifications-container');
                container.innerHTML = '';
                notificationCount = 0;
                updateNotificationBadge();
            }
            // åˆ‡æ¢é€šçŸ¥é¢æ¿æ˜¾ç¤º/éšè—
               function toggleNotificationPanel() {
                const panel = document.getElementById('notification-panel');
                panel.classList.toggle('visible');

                // å¦‚æœé¢æ¿æ‰“å¼€ï¼Œæ ‡è®°æ‰€æœ‰é€šçŸ¥ä¸ºå·²è¯»
                if (panel.classList.contains('visible')) {
                    const unreadItems = panel.querySelectorAll('.notification-item.unread');
                    unreadItems.forEach(item => {
                        item.classList.remove('unread');
                    });
                    notificationCount = 0;
                    updateNotificationBadge();
                }
            }

        // End of toggleNotificationPanel function
    </script>
    <script>
        // ç¡®ä¿Bootstrapç»„ä»¶æ­£å¸¸å·¥ä½œ
        document.addEventListener('DOMContentLoaded', function() {
            // åˆå§‹åŒ–ä¸‹æ‹‰èœå•
            var dropdownElementList = [].slice.call(document.querySelectorAll('[data-bs-toggle="dropdown"]'));
            dropdownElementList.map(function(dropdownToggleEl) {
                return new bootstrap.Dropdown(dropdownToggleEl);
            });

            // åˆå§‹åŒ–æ¨¡æ€æ¡†
            var modalElements = [].slice.call(document.querySelectorAll('.modal'));
            modalElements.map(function(modalElement) {
                // æ£€æŸ¥æ¨¡æ€æ¡†æ˜¯å¦å·²ç»è¢«åˆå§‹åŒ–
                if (!bootstrap.Modal.getInstance(modalElement)) {
                    return new bootstrap.Modal(modalElement, {
                        backdrop: true,
                        keyboard: true
                    });
                }
            });

            // ç¡®ä¿åä½œæ¨¡æ€æ¡†èƒ½æ­£ç¡®å…³é—­
            var collaborationModal = document.getElementById('collaborationModal');
            if (collaborationModal) {
                // ä¸ºæ¨¡æ€æ¡†çš„å…³é—­æŒ‰é’®æ·»åŠ äº‹ä»¶ç›‘å¬å™¨
                collaborationModal.addEventListener('hidden.bs.modal', function () {
                    console.log('Collaboration modal closed');
                    // æ¸…ç†å¯èƒ½çš„æ®‹ç•™çŠ¶æ€
                    var backdrop = document.querySelector('.modal-backdrop');
                    if (backdrop) {
                        backdrop.remove();
                    }
                });
            }

            // å¤„ç†Profileé“¾æ¥ç‚¹å‡»äº‹ä»¶ï¼ˆä»…åœ¨å…ƒç´ å­˜åœ¨æ—¶æ·»åŠ ç›‘å¬å™¨ï¼‰
            var profileLink = document.getElementById('profileLink');
            if (profileLink) {
                profileLink.addEventListener('click', function(e) {
                    e.preventDefault();
                    window.location.href = '/profile';
                });
            }

            // å¤„ç†Logouté“¾æ¥ç‚¹å‡»äº‹ä»¶ï¼ˆä»…åœ¨å…ƒç´ å­˜åœ¨æ—¶æ·»åŠ ç›‘å¬å™¨ï¼‰
            var logoutLink = document.getElementById('logoutLink');
            if (logoutLink) {
                logoutLink.addEventListener('click', function(e) {
                    e.preventDefault();
                    performLogout();
                });
            }
        });

        // æ‰§è¡Œç™»å‡ºæ“ä½œ
        function performLogout() {
            fetch('/api/auth/logout', {
                method: 'POST',
                headers: {
                    'Content-Type': 'application/json'
                }
            })
                .then(response => {
                    if (response.ok) {
                        // ç™»å‡ºæˆåŠŸï¼Œé‡å®šå‘åˆ°ç™»å½•é¡µé¢
                        window.location.href = '/login?logout';
                    } else {
                        console.error('Logout failed');
                        // å³ä½¿å¤±è´¥ä¹Ÿé‡å®šå‘åˆ°ç™»å½•é¡µé¢
                        window.location.href = '/login?logout';
                    }
                })
                .catch(error => {
                    console.error('Logout error:', error);
                    // å³ä½¿å‡ºé”™ä¹Ÿé‡å®šå‘åˆ°ç™»å½•é¡µé¢
                    window.location.href = '/login?logout';
                });
        }

    </script>
</body>
</html>
<!-- Syntax error fixed - final check -->