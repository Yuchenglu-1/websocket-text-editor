<!DOCTYPE html>
<html xmlns:th="http://www.thymeleaf.org">
<head>
    <title>Code Share Editor</title>
    <meta charset="utf-8">
    <meta name="viewport" content="width=device-width, initial-scale=1">
    <!-- CSRF‰ª§ÁâåÂÖÉÊï∞ÊçÆÔºåÁî®‰∫éÈò≤Ê≠¢Ë∑®Á´ôËØ∑Ê±Ç‰º™ÈÄ†ÊîªÂáª -->
    <meta name="_csrf" th:if="${_csrf}" th:content="${_csrf.token}"/>
    <meta name="_csrf_header" th:if="${_csrf}" th:content="${_csrf.headerName}"/>
    
    <!-- MonacoÁºñËæëÂô®Ê†∑Âºè -->
    <link rel="stylesheet" data-name="vs/editor/editor.main" href="https://cdn.jsdelivr.net/npm/monaco-editor@latest/min/vs/editor/editor.main.css">
    <!-- ÂÖ®Â±ÄÊ†∑ÂºèË°® -->
    <link rel="stylesheet" th:href="@{/style.css}">
    <!-- ÁºñËæëÂô®È°µÈù¢‰∏ìÁî®Ê†∑ÂºèË°® -->
    <link rel="stylesheet" th:href="@{/css/editor.css}">
    
    <!-- Ê∑ªÂä†SockJSÂíåSTOMPÂ∫ìÔºåÁî®‰∫éWebSocketÈÄö‰ø° -->
    <script src="https://cdn.jsdelivr.net/npm/sockjs-client@1/dist/sockjs.min.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/stompjs@2/lib/stomp.min.js"></script>
    <!-- Ê∑ªÂä† WebSocket ÁÆ°ÁêÜÂô® -->
    <script src="/js/websocket-manager.js"></script>
    
    <script th:inline="javascript">
        /*<![CDATA[*/
        // ‰ªéURLË∑ØÂæÑ‰∏≠ÊèêÂèñÊñáÊ°£IDÁöÑËæÖÂä©ÂáΩÊï∞
        function getDocIdFromUrl() {
            const pathParts = window.location.pathname.split('/');
            if (pathParts.length >= 3 && pathParts[1] === 'editor') {
                return pathParts[2];
            }
            return null;
        }
        
        // Ë∞ÉËØïÂáΩÊï∞ÔºåÁî®‰∫éÊ£ÄÊü•Thymeleaf‰º†ÈÄíÁöÑÂèòÈáè
        function debugThymeleafVariables() {
            console.log('Debugging Thymeleaf variables:');
            console.log('ywsUrl:', /*[[${ywsUrl}]]*/ 'not set');
            console.log('document.uniqueId:', /*[[${document.uniqueId}]]*/ 'not set');
            console.log('document.content:', /*[[${document.content}]]*/ 'not set');
            console.log('document.title:', /*[[${document.title}]]*/ 'not set');
            console.log('document.language:', /*[[${document.language}]]*/ 'not set');
            console.log('canEdit:', /*[[${canEdit}]]*/ false);
            console.log('currentUser.username:', /*[[${currentUser.username}]]*/ 'not set');
        }
        
        // È°µÈù¢Âä†ËΩΩÊó∂Ë∞ÉÁî®Ë∞ÉËØïÂáΩÊï∞
        debugThymeleafVariables();
        /*]]>*/
    </script>
</head>
<body>
    <!-- Ê∑ªÂä†Êï∞ÊçÆÂ±ûÊÄßÊù•‰º†ÈÄíÁî®Êà∑Âêç -->
    <div id="user-context" 
         th:data-username="${currentUser.username}" 
         th:data-user-id="${currentUser.id}" 
         style="display: none;"></div>
    
    <!-- ÁºñËæëÂô®È°µÈù¢Â§¥ÈÉ®ÂØºËà™Ê†è -->
    <div class="editor-header">
        <div class="container-fluid">
            <div class="d-flex justify-content-between align-items-center">
                <div class="d-flex align-items-center">
                    <!-- ËøîÂõû‰ª™Ë°®ÊùøÈìæÊé• -->
                    <a href="/" class="btn btn-sm btn-outline-secondary me-2">‚Üê Dashboard</a>
                    <!-- ÊñáÊ°£Ê†áÈ¢òÊòæÁ§∫ -->
                    <h1 class="h5 mb-0">üìù <span th:text="${document.title ?: 'Untitled Document'}">Document Title</span></h1>
                </div>
                
                <!-- Ê∑ªÂä†Áî®Êà∑‰ø°ÊÅØÊòæÁ§∫ -->
                <div class="user-info" style="position: absolute; top: 0; right: 0; background: #2196F3; color: white; padding: 5px; font-size: 12px; z-index: 1000;">
                    <span>User:<span th:text="${currentUser.username ?: 'NULL'}">NULL</span></span>
                </div>
                
                <div class="d-flex align-items-center">
                    <!-- ËØ≠Ë®ÄÈÄâÊã©Âô® -->
                    <select class="form-select form-select-sm me-2" id="language-selector">
                        <option value="javascript" th:selected="${document.language == 'javascript'}">JavaScript</option>
                        <option value="typescript" th:selected="${document.language == 'typescript'}">TypeScript</option>
                        <option value="html" th:selected="${document.language == 'html'}">HTML</option>
                        <option value="css" th:selected="${document.language == 'css'}">CSS</option>
                        <option value="java" th:selected="${document.language == 'java'}">Java</option>
                        <option value="python" th:selected="${document.language == 'python'}">Python</option>
                        <option value="cpp" th:selected="${document.language == 'cpp'}">C++</option>
                        <option value="csharp" th:selected="${document.language == 'csharp'}">C#</option>
                        <option value="php" th:selected="${document.language == 'php'}">PHP</option>
                        <option value="sql" th:selected="${document.language == 'sql'}">SQL</option>
                        <option value="plaintext" th:selected="${document.language == 'plaintext'}">Plaintext</option>
                        <option value="json" th:selected="${document.language == 'json'}">JSON</option>
                        <option value="xml" th:selected="${document.language == 'xml'}">XML</option>
                    </select>
                    
                    <!-- ËØÑËÆ∫Âíå‰ªªÂä°ÊåâÈíÆ -->
                    <button id="tasks-btn" class="btn btn-sm btn-success me-2">
                        <i class="fas fa-comments me-1"></i>comments/tasks
                        </a>
                    </button>
                    
                    <!-- Âú®Á∫øÁî®Êà∑ÊåâÈíÆ -->
                    <button id="online-users-btn" class="btn btn-sm btn-success me-2">
                        <i class="fas fa-users me-1"></i>online-users
                    </button>
                    
                    <!-- Âçè‰ΩúÂäüËÉΩÊåâÈíÆÔºå‰ªÖÊñáÊ°£ÊâÄÊúâËÄÖÂèØËßÅ -->
                    <button id="collaboration-btn" class="btn btn-sm btn-info me-2" th:if="${userPermission.name() == 'OWNER'}">
                        üë• Collaborate
                    </button>
                    
                    <!-- ‰øùÂ≠òÊåâÈíÆ -->
                    <button id="save-btn" class="btn btn-sm btn-success me-2">
                        üíæ Save
                    </button>
                    
                    <!-- ÈÄöÁü•ÊåâÈíÆ -->
                    <div class="notification-container">
                        <button id="notification-btn" class="btn btn-sm btn-outline-primary">
                            <i class="fas fa-bell"></i> üîî
                        </button>
                        <!-- ÈÄöÁü•ÂæΩÁ´†ÔºåÊòæÁ§∫Êú™ËØªÈÄöÁü•Êï∞Èáè -->
                        <span id="notification-badge" class="notification-badge" style="display: none;">0</span>
                    </div>
                    
                    <!-- ËøûÊé•Áä∂ÊÄÅÊåáÁ§∫Âô® -->
                    <div class="connection-status-container">
                        <span class="connection-label">Connection:</span>
                        <span class="connection-indicator disconnected">
                            <span class="status-dot"></span>
                            <span class="connection-status">disconnected</span>
                        </span>
                    </div>
                </div>
            </div>
        </div>
    </div>

    <!-- ÈÄöÁü•Èù¢Êùø -->
    <div id="notification-panel" class="notification-panel">
        <div class="notification-header">
            <h6>ÈÄöÁü•</h6>
            <!-- Ê∏ÖÈô§ÊâÄÊúâÈÄöÁü•ÊåâÈíÆ -->
            <button id="clear-notifications" class="btn btn-sm btn-outline-secondary">Ê∏ÖÈô§</button>
        </div>
        <div id="notifications-container" class="notifications-container">
            <!-- ÈÄöÁü•ÂÜÖÂÆπÂ∞ÜÈÄöËøáJavaScriptÂä®ÊÄÅÊ∑ªÂä† -->
        </div>
    </div>

    <!-- Âçè‰ΩúÊ®°ÊÄÅÊ°Ü -->
    <div class="modal fade" id="collaborationModal" tabindex="-1" aria-labelledby="collaborationModalLabel" aria-hidden="true" style="display: none;">
        <div class="modal-dialog modal-lg">
            <div class="modal-content">
                <div class="modal-header">
                    <h5 class="modal-title" id="collaborationModalLabel">üë• Document Collaboration</h5>
                    <!-- ÂÖ≥Èó≠Ê®°ÊÄÅÊ°ÜÊåâÈíÆ -->
                    <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Close">
                        <span aria-hidden="true">Close</span>
                    </button>
                </div>
                <div class="modal-body">
                    <div class="mb-4">
                        <h6>Invite Users</h6>
                        <!-- ÈÇÄËØ∑Áî®Êà∑ËæìÂÖ•Ê°ÜÂíåÈÄâÊã©Âô® -->
                        <div class="input-group mt-3">
                            <input type="text" class="form-control" id="invite-uuid" placeholder="Enter invitation UUID...">
                            <select class="form-select form-select-sm permission-select-uuid" id="permission-select-uuid">
                                <option value="EDITOR">Editor</option>
                                <option value="VIEWER">Viewer</option>
                            </select>
                            <button class="btn btn-primary" type="button" id="invite-by-uuid-btn">Invite</button>
                        </div>
                    </div>
                    
                    <div class="mb-4">
                        <h6>Document Collaborators</h6>
                        <div id="collaborators-list">
                            <!-- Âçè‰ΩúËÄÖÂàóË°®Â∞ÜÈÄöËøáJavaScriptÂä†ËΩΩ -->
                        </div>
                    </div>
                </div>
            </div>
        </div>
    </div>

    <!-- ÁºñËæëÂô®ÂÆπÂô® -->
    <div id="editor-container" th:class="${canEdit ? '' : 'read-only'}"></div>
    
    <!-- Ê∑ªÂä†Êï∞ÊçÆÂ±ûÊÄßÊù•‰º†ÈÄíÊñáÊ°£ÂÜÖÂÆπ -->
    <div id="document-context" 
         th:data-content="${document.content}" 
         style="display: none;"></div>
    
    <!-- ÂÖâÊ†áË¶ÜÁõñÂ±ÇÔºåÁî®‰∫éÊòæÁ§∫ÂÖ∂‰ªñÁî®Êà∑ÁöÑÂÖâÊ†á‰ΩçÁΩÆ -->
    <div id="cursor-overlay"></div>
    
    <!-- ToastÊ∂àÊÅØÂÆπÂô® -->
    <div id="toast-container"></div>
    <!-- Ê∑ªÂä†Bootstrap JS -->
    <script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.3/dist/js/bootstrap.bundle.min.js"></script>
    <!-- Monaco Editor -->
    <script src="https://cdn.jsdelivr.net/npm/monaco-editor@latest/min/vs/loader.js"></script>
    <script type="module">
        /*<![CDATA[*/
        const ywsUrl = /*[[${ywsUrl}]]*/ 'ws://localhost:1234';
        // ‰ΩøÁî®‰ªéURLËé∑ÂèñÁöÑÊñáÊ°£IDÔºåÂ¶ÇÊûúËé∑Âèñ‰∏çÂà∞Âàô‰ΩøÁî®ThymeleafÊèê‰æõÁöÑID
        const docIdFromUrl = getDocIdFromUrl();
        const docId = docIdFromUrl || /*[[${document.uniqueId}]]*/ 'default-room';
        // ‰ªéHTMLÊï∞ÊçÆÂ±ûÊÄßËé∑ÂèñÂΩìÂâçÁî®Êà∑Âêç
        const userContext = document.getElementById('user-context');
        const currentUsername = userContext ? userContext.getAttribute('data-username') : 'Anonymous';
        // ‰øÆÂ§çÔºö‰ΩøÁî®HTMLÊï∞ÊçÆÂ±ûÊÄß‰º†ÈÄíÊñáÊ°£ÂÜÖÂÆπÔºåÈÅøÂÖçThymeleaf JavaScriptÂÜÖËÅîÂ§ÑÁêÜÈóÆÈ¢ò
        const documentContent = document.getElementById('document-context') ? document.getElementById('document-context').getAttribute('data-content') : '';
        const canEdit = /*[[${canEdit}]]*/ true;
        // Ê£ÄÊü•ÂΩìÂâçÊòØÂê¶ÊòØÊñ∞ÊñáÊ°£
        let isNewDocument = docId === 'default-room';
        
        // Ë∞ÉËØï‰ø°ÊÅØ - Ê£ÄÊü•‰º†ÂÖ•ÁöÑÁî®Êà∑‰ø°ÊÅØ
        console.log('Current user from Thymeleaf:', /*[[${currentUser}]]*/ 'No user data');
        console.log('Current username:', currentUsername);
        console.log('Document content from data attribute:', documentContent);
        /*]]>*/

        import * as Y from 'https://esm.sh/yjs@14.0.0-6';
        import { WebsocketProvider } from 'https://esm.sh/@y/websocket@4.0.0-1?alias=yjs:https://esm.sh/yjs@14.0.0-6';

        // Ê∑ªÂä†SockJSÂíåSTOMPÂ∫ìÁî®‰∫éWebSocketÈÄöÁü•
        let notificationCount = 0;

        let monacoEditor;
        let provider;
        let awareness;
        let isUpdatingFromY = false;

        // Initialize Monaco Editor
        require.config({ paths: { vs: 'https://cdn.jsdelivr.net/npm/monaco-editor@latest/min/vs' } });
        require(['vs/editor/editor.main'], function () {
            // Configure Monaco
            monaco.editor.defineTheme('code-share-theme', {
                base: 'vs',
                inherit: true,
                rules: [],
                colors: {
                    'editor.background': '#ffffff',
                    'editor.foreground': '#333333',
                    'editorLineNumber.foreground': '#999999',
                    'editor.selectionBackground': '#add6ff',
                    'editor.inactiveSelectionBackground': '#e5ebf1'
                }
            });


            //Ê£ÄÊµãÊòØÂê¶‰∏∫ÁßªÂä®ËÆæÂ§á
            const isMobile = /Android|webOS|iPhone|iPad|iPod|BlackBerry|IEMobile|Opera Mini/i.test(navigator.userAgent);
            
            // ÂàùÂßãÂåñËØ≠Ë®Ä
            const initialLanguage = /*[[${document.language}]]*/ 'javascript';
            
            monacoEditor = monaco.editor.create(document.getElementById('editor-container'), {
                value: '// Welcome to Code Share!\n// Start typing your code here...\n\n',
                language: initialLanguage,
                theme: 'code-share-theme',
                fontSize: isMobile ? 16 : 14, // Larger font on mobile to prevent zoom
                fontFamily: "'Fira Code', 'Cascadia Code', 'JetBrains Mono', 'Source Code Pro', monospace",
                lineNumbers: isMobile ? 'off' : 'on', // Hide line numbers on mobile for more space
                minimap: { enabled: false },
                scrollBeyondLastLine: false,
                automaticLayout: true,
                wordWrap: 'on',
                folding: !isMobile, // Disable folding on mobile
                renderLineHighlight: 'all',
                selectOnLineNumbers: !isMobile,
                roundedSelection: false,
                readOnly: !canEdit, // Ê†πÊçÆÁî®Êà∑ÊùÉÈôêËÆæÁΩÆÁºñËæëÂô®ÊòØÂê¶Âè™ËØª
                cursorStyle: 'line',
                cursorBlinking: 'blink',
                tabSize: 4,
                insertSpaces: true,
                // Mobile-specific options
                mouseWheelZoom: false, // Disable zoom with mouse wheel
                contextmenu: !isMobile, // Disable context menu on mobile
                quickSuggestions: !isMobile, // Disable suggestions on mobile to prevent UI interference
                suggestOnTriggerCharacters: !isMobile,
                acceptSuggestionOnEnter: 'off', // Prevent accidental suggestion acceptance
                parameterHints: { enabled: !isMobile },
                hover: { enabled: !isMobile },
                links: false, // Disable links on mobile
                colorDecorators: !isMobile,
                lightbulb: { enabled: false }, // Disable lightbulb on mobile
                overviewRulerBorder: false,
                hideCursorInOverviewRuler: true,
                scrollbar: {
                    useShadows: false,
                    verticalHasArrows: false,
                    horizontalHasArrows: false,
                    vertical: isMobile ? 'hidden' : 'auto',
                    horizontal: isMobile ? 'hidden' : 'auto'
                }
            });

            initializeCollaboration();
            
            // ÊúÄÁªàÊ£ÄÊü•ÔºöÁ°Æ‰øùÊñáÊ°£ÂÜÖÂÆπÊ≠£Á°ÆÂä†ËΩΩ
            setTimeout(function() {
                console.log('Final check for document content');
                
                // Ê£ÄÊü•ÊòØÂê¶ÈúÄË¶Å‰ªéÊï∞ÊçÆÂ∫ìÂä†ËΩΩÂÜÖÂÆπ
                if (documentContent && documentContent.trim() !== '' && 
                    typeof ytext !== 'undefined' && 
                    ytext.toString().trim() === '' && 
                    (monacoEditor.getValue().trim() === '// Welcome to Code Share!\n// Start typing your code here...\n\n' ||
                     monacoEditor.getValue().trim() === '')) {
                    
                    console.log('Loading document content from database in final check:', documentContent);
                    console.log('Document content length:', documentContent.length);
                    console.log('Document content char codes:', documentContent.split('').map(c => c.charCodeAt(0)));
                    
                    // Êõ¥Êñ∞Y.jsÂÜÖÂÆπ
                    ytext.insert(0, documentContent);
                    
                    // Êõ¥Êñ∞ÁºñËæëÂô®ÂÜÖÂÆπ
                    isUpdatingFromY = true;
                    monacoEditor.setValue(documentContent);
                    isUpdatingFromY = false;
                }
                
                console.log('Document content after final check:', monacoEditor.getValue());
                console.log('Document content length after final check:', monacoEditor.getValue().length);
            }, 1500);
            
            // Á°Æ‰øùÂú®ÁºñËæëÂô®ÂàùÂßãÂåñÂÆåÊàêÂêéÊ∑ªÂä†‰∫ã‰ª∂ÁõëÂê¨Âô®
            function attachEventListeners() {
                // ‰øùÂ≠òÂäüËÉΩ
                const saveBtn = document.getElementById('save-btn');
                if (saveBtn) {
                    saveBtn.addEventListener('click', async function() {
                        // Ê£ÄÊü•Áî®Êà∑ÊòØÂê¶ÊúâÁºñËæëÊùÉÈôê
                        if (!canEdit) {
                            showToast('You do not have permission to save this document.');
                            return;
                        }
                        
                        try {
                            const content = monacoEditor.getValue();
                            const language = document.getElementById('language-selector').value;
                            const titleElement = document.querySelector('h1 span');
                            const title = titleElement ? titleElement.textContent : 'Untitled Document';
                            
                            // ÂØπ‰∫éÊñ∞ÊñáÊ°£ÔºàID‰∏∫'default-room'ÔºâÔºå‰∏çÊâßË°å‰ªª‰ΩïÊìç‰Ωú
                            if (docId === 'default-room') {
                                showToast('Please create a new document first using the "New Document" button on the dashboard.');
                                return;
                            }
                            
                            const response = await fetch(`/documents/update-title/${docId}`, {
                                method: 'POST',
                                headers: {
                                    'Content-Type': 'application/json',
                                    'X-CSRF-TOKEN': document.querySelector('meta[name="_csrf"]')?.getAttribute('content') || ''
                                },
                                body: JSON.stringify({ title: title }) // ‰ΩøÁî®ÂΩìÂâçÊ†áÈ¢òËÄå‰∏çÊòØÊñ∞Ê†áÈ¢ò
                            });
                            
                            if (response.ok) {
                                
                                // ‰øùÂ≠òÊñáÊ°£ÂÜÖÂÆπ
                                const saveResponse = await fetch('/documents/save', {
                                    method: 'POST',
                                    headers: {
                                        'Content-Type': 'application/x-www-form-urlencoded',
                                        'X-CSRF-TOKEN': document.querySelector('meta[name="_csrf"]')?.getAttribute('content') || ''
                                    },
                                    body: new URLSearchParams({
                                        documentId: docId,
                                        content: content,
                                        language: language,
                                        title: title // ‰ΩøÁî®ÂΩìÂâçÊ†áÈ¢òËÄå‰∏çÊòØÊñ∞Ê†áÈ¢ò
                                    })
                                });
                                
                                if (saveResponse.ok) {
                                    showToast('Document saved successfully!');
                                } else {
                                    showToast('Failed to save document content.');
                                }
                            } else {
                                showToast('Failed to update document title.');
                            }
                        } catch (error) {
                            console.error('Save error:', error);
                            showToast('An error occurred while saving the document.');
                        }
                    });
                }
                
                // ËØÑËÆ∫Âíå‰ªªÂä°ÊåâÈíÆÂäüËÉΩ
                const tasksBtn = document.getElementById('tasks-btn');
                if (tasksBtn) {
                    tasksBtn.addEventListener('click', function(e) {
                        e.preventDefault();
                        // Ë∑≥ËΩ¨Âà∞‰ªªÂä°È°µÈù¢Âπ∂‰º†ÈÄíÊñáÊ°£IDÂíåÁî®Êà∑Âêç
                        window.location.href = `/tasks?docId=${docId}&username=${encodeURIComponent(currentUsername)}`;
                    });
                }
                
                // Âú®Á∫øÁî®Êà∑ÊåâÈíÆÂäüËÉΩ
                const onlineUsersBtn = document.getElementById('online-users-btn');
                if (onlineUsersBtn) {
                    onlineUsersBtn.addEventListener('click', function(e) {
                        e.preventDefault();
                        // Ë∑≥ËΩ¨Âà∞Âú®Á∫øÁî®Êà∑È°µÈù¢
                        window.location.href = '/online-users';
                    });
                }
                
                // Âçè‰ΩúÂäüËÉΩ
                const collaborationBtn = document.getElementById('collaboration-btn');
                if (collaborationBtn) {
                    collaborationBtn.addEventListener('click', function() {
                        const modal = new bootstrap.Modal(document.getElementById('collaborationModal'));
                        modal.show();
                        loadCollaborators();
                    });
                }
                
                // ËØ≠Ë®ÄÈÄâÊã©Âô®
                const languageSelector = document.getElementById('language-selector');
                if (languageSelector) {
                    languageSelector.addEventListener('change', function() {
                        const newLanguage = this.value;
                        monaco.editor.setModelLanguage(monacoEditor.getModel(), newLanguage);
                    });
                }
                
                // Ê∑ªÂä†ÈÄöÁü•Áõ∏ÂÖ≥ÁöÑ‰∫ã‰ª∂ÁõëÂê¨Âô®
                const notificationBtn = document.getElementById('notification-btn');
                if (notificationBtn) {
                    notificationBtn.addEventListener('click', toggleNotificationPanel);
                }
                
                const clearNotificationsBtn = document.getElementById('clear-notifications');
                if (clearNotificationsBtn) {
                    clearNotificationsBtn.addEventListener('click', clearNotifications);
                }
                
                // ÁÇπÂáªÈù¢ÊùøÂ§ñÂÖ≥Èó≠ÈÄöÁü•Èù¢Êùø
                document.addEventListener('click', function(e) {
                    const notificationPanel = document.getElementById('notification-panel');
                    const notificationBtn = document.getElementById('notification-btn');
                    
                    if (notificationPanel && notificationBtn && 
                        notificationPanel.classList.contains('visible') &&
                        !notificationPanel.contains(e.target) && 
                        !notificationBtn.closest('.notification-container').contains(e.target)) {
                        notificationPanel.classList.remove('visible');
                    }
                });
            }
            
            // Âú®DOMÂä†ËΩΩÂÆåÊàêÂêéÁªëÂÆö‰∫ã‰ª∂ÁõëÂê¨Âô®
            if (document.readyState === 'loading') {
                document.addEventListener('DOMContentLoaded', attachEventListeners);
            } else {
                attachEventListeners();
            }
            
            // È°µÈù¢ÂÆåÂÖ®Âä†ËΩΩÂêéÂÜçÊ¨°Ê£ÄÊü•ÊñáÊ°£ÂÜÖÂÆπÂêåÊ≠•
            window.addEventListener('load', function() {
                setTimeout(function() {
                    console.log('Window loaded, checking document content sync');
                    
                    // Ê£ÄÊü•Y.jsÂÜÖÂÆπÂíåMonacoÁºñËæëÂô®ÂÜÖÂÆπÊòØÂê¶ÂêåÊ≠•
                    if (typeof ytext !== 'undefined') {
                        const yjsContent = ytext.toString();
                        const editorContent = monacoEditor.getValue();
                        
                        console.log('Y.js content:', yjsContent);
                        console.log('Y.js content length:', yjsContent.length);
                        console.log('Editor content:', editorContent);
                        console.log('Editor content length:', editorContent.length);
                        
                        // Âè™ÊúâÂΩìÁºñËæëÂô®ÂÜÖÂÆπÊòØÈªòËÆ§ÂÜÖÂÆπ‰∏îY.jsÊúâÂÜÖÂÆπÊó∂ÊâçÂêåÊ≠•
                        if (yjsContent.trim() !== '' && 
                            editorContent.trim() === '// Welcome to Code Share!\n// Start typing your code here...\n\n') {
                            console.log('Syncing editor with Y.js content after window load');
                            isUpdatingFromY = true;
                            monacoEditor.setValue(yjsContent);
                            isUpdatingFromY = false;
                        }
                        // Â¶ÇÊûúÊï∞ÊçÆÂ∫ìÊúâÂÜÖÂÆπ‰ΩÜY.js‰∏∫Á©∫ÔºåÂàùÂßãÂåñY.js
                        else if (yjsContent.trim() === '' && documentContent && documentContent.trim() !== '') {
                            console.log('Initializing Y.js with database content after window load:', documentContent);
                            ytext.insert(0, documentContent);
                        }
                        // Â¶ÇÊûúY.js‰∏∫Á©∫ÔºåÁºñËæëÂô®ÊúâÈªòËÆ§ÂÜÖÂÆπÔºå‰ΩÜÊï∞ÊçÆÂ∫ìÊúâÂÜÖÂÆπÔºåÂàôÁî®Êï∞ÊçÆÂ∫ìÂÜÖÂÆπÊõøÊç¢
                        else if (yjsContent.trim() === '' && 
                                 documentContent && documentContent.trim() !== '' &&
                                 (editorContent.trim() === '// Welcome to Code Share!\n// Start typing your code here...\n\n' ||
                                  editorContent.trim() === '')) {
                            console.log('Replacing default content with database content after window load:', documentContent);
                            ytext.insert(0, documentContent);
                            isUpdatingFromY = true;
                            monacoEditor.setValue(documentContent);
                            isUpdatingFromY = false;
                        }
                    }
                }, 1000);
            });
        });
        // ‰øÆÊîπÊùÉÈôê‰∏ãÊãâËèúÂçï‰∫ã‰ª∂ÁõëÂê¨Âô®
        document.addEventListener('change', function(e) {
            if (e.target.classList.contains('permission-select')) {
                const userId = e.target.dataset.userId;
                const newPermission = e.target.value;
                updateCollaboratorPermission(userId, newPermission);
            }
        });

        // ÁßªÈô§Âçè‰ΩúËÄÖÊåâÈíÆ‰∫ã‰ª∂ÁõëÂê¨Âô®
        document.addEventListener('click', function(e) {
            if (e.target.classList.contains('remove-collaborator')) {
                const userId = e.target.dataset.userId;
                removeCollaborator(userId);
            }
        });
        // ÂàùÂßãÂåñÂçè‰ΩúÂäüËÉΩ
        function initializeCollaboration() {
            // ÈáçÊñ∞Ëé∑ÂèñinitialLanguageÔºåÂõ†‰∏∫Âú®ËØ•ÂáΩÊï∞‰ΩúÁî®ÂüüÂÜÖÊó†Ê≥ïËÆøÈóÆÂ§ñÈÉ®ÂÆö‰πâÁöÑÂèòÈáè
            const initialLanguage = /*[[${document.language}]]*/ 'javascript';
            
            const ydoc = new Y.Doc();
            provider = new WebsocketProvider(ywsUrl, docId, ydoc);
            const ytext = ydoc.getText('monaco');
            awareness = provider.awareness;
            const localClientId = awareness.clientID || ydoc.clientID;

            // ËæìÂá∫Ë∞ÉËØï‰ø°ÊÅØ
            console.log('Initializing collaboration with documentContent:', documentContent);
            console.log('Y.js document ID:', docId);
            console.log('Current username:', currentUsername);

            // Set user awareness
            const localUser = { 
                name: currentUsername, 
                color: colorFromId(localClientId),
                language: initialLanguage
            };
            awareness.setLocalState({ user: localUser, cursor: null });

            // Y.js to Monaco synchronization
            ytext.observe(event => {
                if (isUpdatingFromY) return;
                
                const content = ytext.toString();
                console.log('Y.js content changed:', content);
                console.log('Y.js content length:', content.length);
                console.log('Y.js content char codes:', content.split('').map(c => c.charCodeAt(0)));
                
                // Âè™ÊúâÂΩìÂÜÖÂÆπÁúüÊ≠£ÂèëÁîüÂèòÂåñÊó∂ÊâçÊõ¥Êñ∞ÁºñËæëÂô®
                if (monacoEditor.getValue() !== content) {
                    isUpdatingFromY = true;
                    monacoEditor.setValue(content);
                    isUpdatingFromY = false;
                    console.log('Monaco editor updated from Y.js');
                }
            });

            // Monaco to Y.js synchronization
            monacoEditor.onDidChangeModelContent((event) => {
                if (isUpdatingFromY) return;
                
                ydoc.transact(() => {
                    const changes = event.changes.sort((a, b) => b.rangeOffset - a.rangeOffset);
                    
                    for (const change of changes) {
                        if (change.rangeLength > 0) {
                            ytext.delete(change.rangeOffset, change.rangeLength);
                        }
                        if (change.text.length > 0) {
                            ytext.insert(change.rangeOffset, change.text);
                        }
                    }
                }, 'monaco');
            });

            // Handle connection status
            const connectionStatusEl = document.querySelector('.connection-status');
            const connectionIndicator = document.querySelector('.connection-indicator');
            provider.on('status', event => {
                connectionStatusEl.textContent = event.status;
                connectionIndicator.className = 'connection-indicator ' + event.status;
            });

            // Set initial content on sync
            provider.on('sync', isSynced => {
                if (isSynced) {
                    const content = ytext.toString();
                    console.log('Y.js synced, content:', content);
                    console.log('Y.js synced, content length:', content.length);
                    console.log('Database content:', documentContent);
                    console.log('Database content length:', documentContent ? documentContent.length : 'null');
                    
                    // Âè™ÊúâÂΩìÁºñËæëÂô®ÂÜÖÂÆπ‰∏∫Á©∫ÊàñËÄÖ‰∏éY.jsÂÜÖÂÆπ‰∏çÂêåÊó∂ÊâçÊõ¥Êñ∞
                    if ((monacoEditor.getValue().trim() === '' || monacoEditor.getValue() !== content) && content.trim() !== '') {
                        isUpdatingFromY = true;
                        monacoEditor.setValue(content);
                        isUpdatingFromY = false;
                        console.log('Monaco editor updated with Y.js content');
                    }
                    // Â¶ÇÊûúY.jsÂÜÖÂÆπ‰∏∫Á©∫‰ΩÜÊï∞ÊçÆÂ∫ìÊúâÂÜÖÂÆπÔºåÂàôÁî®Êï∞ÊçÆÂ∫ìÂÜÖÂÆπÂàùÂßãÂåñ
                    else if (content.trim() === '' && documentContent && documentContent.trim() !== '') {
                        console.log('Initializing Y.js with database content:', documentContent);
                        ytext.insert(0, documentContent);
                    }
                    // Â¶ÇÊûúY.jsÂíåÊï∞ÊçÆÂ∫ìÈÉΩÊ≤°ÊúâÂÜÖÂÆπÔºå‰ΩÜÁºñËæëÂô®‰∏∫Á©∫ÔºåÂàôÁî®ÈªòËÆ§ÂÜÖÂÆπÂàùÂßãÂåñ
                    else if (content.trim() === '' && (!documentContent || documentContent.trim() === '') && monacoEditor.getValue().trim() === '') {
                        console.log('Initializing with default content');
                        const defaultContent = '// Welcome to Code Share!\n// Start typing your code here...\n\n';
                        ytext.insert(0, defaultContent);
                    }
                }
            });

            // Â¶ÇÊûúÊàë‰ª¨ÊúâÊï∞ÊçÆÂ∫ìÂÜÖÂÆπ‰∏îYText‰∏∫Á©∫ÔºåÂàôÁî®Êï∞ÊçÆÂ∫ìÂÜÖÂÆπÂàùÂßãÂåñY.jsÊñáÊ°£
            // Ëøô‰∏™ÈÄªËæëÈúÄË¶ÅÂú®observe‰∫ã‰ª∂ÁªëÂÆö‰πãÂêéÊâßË°åÔºå‰ª•Á°Æ‰øùÂÜÖÂÆπÊ≠£Á°ÆÂêåÊ≠•
            // Á°Æ‰øùÂú®Y.jsÂêåÊ≠•ÂÆåÊàêÂêéÂÜçËÆæÁΩÆÂàùÂßãÂÜÖÂÆπ
            setTimeout(() => {
                // Âè™ÊúâÂΩìY.jsÊñáÊú¨‰∏∫Á©∫‰∏îÊàë‰ª¨ÊúâÊï∞ÊçÆÂ∫ìÂÜÖÂÆπÊó∂ÊâçËÆæÁΩÆÂàùÂßãÂÜÖÂÆπ
                if (ytext.toString().trim() === '' && documentContent && documentContent.trim() !== '') {
                    console.log('Initializing editor with database content after timeout:', documentContent);
                    ytext.insert(0, documentContent);
                }
                // Â¶ÇÊûúY.jsÂ∑≤ÁªèÊúâÂÜÖÂÆπÔºåÁ°Æ‰øùMonacoÁºñËæëÂô®‰πüÂêåÊ≠•
                else if (ytext.toString().trim() !== '' && monacoEditor.getValue().trim() === '') {
                    console.log('Syncing Monaco editor with Y.js content after timeout');
                    isUpdatingFromY = true;
                    monacoEditor.setValue(ytext.toString());
                    isUpdatingFromY = false;
                }
            }, 500);

            setupCursorTracking();
            
            // ËøûÊé•ÈÄöÁü•WebSocket
            connectNotificationWebSocket();
        }
        
        // Âçè‰ΩúÂäüËÉΩ
        document.getElementById('collaboration-btn')?.addEventListener('click', function() {
            const modalElement = document.getElementById('collaborationModal');
            let modal = bootstrap.Modal.getInstance(modalElement);
            if (!modal) {
                modal = new bootstrap.Modal(modalElement, {
                    backdrop: true,
                    keyboard: true
                });
            }
            modal.show();
            loadCollaborators();
        });
        // ÈÇÄËØ∑Áî®Êà∑ÔºàÈÄöËøáUUIDÔºâ
        async function inviteUserByUuid() {
            const invitationUuid = document.getElementById('invite-uuid').value.trim();
            const permissionLevel = document.getElementById('permission-select-uuid').value;
            
            if (!invitationUuid) {
                showToast('Please enter an invitation UUID!');
                return;
            }
            
            try {
                const response = await fetch(`/api/documents/${docId}/invite-by-uuid`, {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/x-www-form-urlencoded'
                    },
                    body: new URLSearchParams({
                        'invitationUuid': invitationUuid,
                        'permissionLevel': permissionLevel
                    })
                });
                
                if (response.ok) {
                    showToast('User invited successfully!');
                    document.getElementById('invite-uuid').value = '';
                    loadCollaborators(); // ÈáçÊñ∞Âä†ËΩΩÂçè‰ΩúËÄÖÂàóË°®
                } else {
                    const errorText = await response.text();
                    showToast('Failed to invite user: ' + errorText);
                }
            } catch (err) {
                console.error('Invite error:', err);
                showToast('Failed to invite user!');
            }
        }
        
        // Ê∑ªÂä†ÈÇÄËØ∑ÊåâÈíÆ‰∫ã‰ª∂ÁõëÂê¨Âô®
        document.getElementById('invite-by-uuid-btn').addEventListener('click', inviteUserByUuid);
        
        // Ê∑ªÂä†ÂõûËΩ¶ÈîÆÁõëÂê¨Âô®
        document.getElementById('invite-uuid').addEventListener('keypress', function(e) {
            if (e.key === 'Enter') {
                inviteUserByUuid();
            }
        });
        
        // Âä†ËΩΩÂçè‰ΩúËÄÖÂàóË°®
        async function loadCollaborators() {
            try {
                const response = await fetch(`/api/documents/${docId}/collaborators`, {
                    method: 'GET',
                    headers: {
                        'Content-Type': 'application/json'
                    }
                });
                
                if (response.ok) {
                    const collaborators = await response.json();
                    displayCollaborators(collaborators);
                } else {
                    showToast('Failed to load collaborators!');
                }
            } catch (err) {
                console.error('Load collaborators error:', err);
                showToast('Failed to load collaborators!');
            }
        }
        document.querySelectorAll('.permission-select').forEach(select => {
            select.addEventListener('change', function() {
                const userId = this.getAttribute('data-user-id');
                const newPermission = this.value;
                updateCollaboratorPermission(userId, newPermission);
            });
        });
        document.querySelectorAll('.remove-collaborator').forEach(button => {
            button.addEventListener('click', function() {
                const userId = this.getAttribute('data-user-id');
                removeCollaborator(userId);
            });
        });
        // ÊòæÁ§∫Âçè‰ΩúËÄÖÂàóË°®
        function displayCollaborators(collaborators) {
            const listContainer = document.getElementById('collaborators-list');
            if (collaborators.length === 0) {
                listContainer.innerHTML = '<div class="alert alert-info">No collaborators yet</div>';
                return;
            }

            let html = '<div class="list-group">';
            collaborators.forEach(collaborator => {
                let permissionBadge = '';
                let actionButtons = '';

                switch (collaborator.permissionLevel) {
                    case 'OWNER':
                        permissionBadge = '<span class="badge bg-primary">Owner</span>';
                        // ÂØπ‰∫éÊã•ÊúâËÄÖÔºå‰∏çÊòæÁ§∫ÁßªÈô§Âíå‰øÆÊîπÊùÉÈôêÁöÑÊéß‰ª∂
                        actionButtons = '';
                        break;
                    case 'EDITOR':
                        permissionBadge = '<span class="badge bg-success">Editor</span>';
                        actionButtons = `
                    <!-- ‰øÆÊîπÊùÉÈôê‰∏ãÊãâËèúÂçï -->
                    <select class="form-select form-select-sm ms-2 permission-select"
                            data-user-id="${collaborator.userId}"
                            style="width: auto;">
                        <option value="EDITOR" ${collaborator.permissionLevel === 'EDITOR' ? 'selected' : ''}>Editor</option>
                        <option value="VIEWER" ${collaborator.permissionLevel === 'VIEWER' ? 'selected' : ''}>Viewer</option>
                    </select>
                    <!-- ÁßªÈô§Âçè‰ΩúËÄÖÊåâÈíÆ -->
                    <button class="btn btn-sm btn-danger ms-2 remove-collaborator"
                            data-user-id="${collaborator.userId}">
                        Remove
                    </button>
                `;
                        break;
                    case 'VIEWER':
                        permissionBadge = '<span class="badge bg-secondary">Viewer</span>';
                        actionButtons = `
                    <!-- ‰øÆÊîπÊùÉÈôê‰∏ãÊãâËèúÂçï -->
                    <select class="form-select form-select-sm ms-2 permission-select"
                            data-user-id="${collaborator.userId}"
                            style="width: auto;">
                        <option value="EDITOR" ${collaborator.permissionLevel === 'EDITOR' ? 'selected' : ''}>Editor</option>
                        <option value="VIEWER" ${collaborator.permissionLevel === 'VIEWER' ? 'selected' : ''}>Viewer</option>
                    </select>
                    <!-- ÁßªÈô§Âçè‰ΩúËÄÖÊåâÈíÆ -->
                    <button class="btn btn-sm btn-danger ms-2 remove-collaborator"
                            data-user-id="${collaborator.userId}">
                        Remove
                    </button>
                `;
                        break;
                }

                html += `
            <div class="list-group-item d-flex justify-content-between align-items-center">
                <div>
                    <strong>${collaborator.username}</strong>
                </div>
                <div class="d-flex align-items-center">
                    ${permissionBadge}
                    ${actionButtons}
                </div>
            </div>
        `;
            });
            html += '</div>';

            listContainer.innerHTML = html;
        }
        //Êõ¥Êñ∞Âçè‰ΩúËÄÖÊùÉÈôê
        async function updateCollaboratorPermission(userId, permissionLevel) {
            try {
                // Ëé∑ÂèñCSRF‰ª§Áâå
                const csrfToken = document.querySelector('meta[name="_csrf"]')?.getAttribute('content');
                const csrfHeader = document.querySelector('meta[name="_csrf_header"]')?.getAttribute('content');

                // ÊûÑÂª∫ËØ∑Ê±ÇÂ§¥
                const headers = {
                    'Content-Type': 'application/json'
                };

                // Â¶ÇÊûúÂ≠òÂú®CSRF‰ª§ÁâåÔºåÂàôÊ∑ªÂä†Âà∞ËØ∑Ê±ÇÂ§¥‰∏≠
                if (csrfToken && csrfHeader) {
                    headers[csrfHeader] = csrfToken;
                }

                const response = await fetch(`/api/documents/${docId}/collaborators/${userId}/permission`, {
                    method: 'PUT',
                    headers: headers,
                    body: JSON.stringify({ permissionLevel: permissionLevel })
                });

                if (response.ok) {
                    showToast('Permission updated successfully!');
                    loadCollaborators(); // ÈáçÊñ∞Âä†ËΩΩÂçè‰ΩúËÄÖÂàóË°®
                } else {
                    const errorMsg = await response.text();
                    showToast('Failed to update permission: ' + errorMsg);
                }
            } catch (err) {
                console.error('Update permission error:', err);
                showToast('Failed to update permission!');
            }
        }
        //ÁßªÈô§Âçè‰ΩúËÄÖ
        async function removeCollaborator(userId) {
            if (!confirm('Are you sure you want to remove this collaborator?')) {
                return;
            }

            try {
                // Ëé∑ÂèñCSRF‰ª§Áâå
                const csrfToken = document.querySelector('meta[name="_csrf"]')?.getAttribute('content');
                const csrfHeader = document.querySelector('meta[name="_csrf_header"]')?.getAttribute('content');

                // ÊûÑÂª∫ËØ∑Ê±ÇÂ§¥
                const headers = {};

                // Â¶ÇÊûúÂ≠òÂú®CSRF‰ª§ÁâåÔºåÂàôÊ∑ªÂä†Âà∞ËØ∑Ê±ÇÂ§¥‰∏≠
                if (csrfToken && csrfHeader) {
                    headers[csrfHeader] = csrfToken;
                }

                const response = await fetch(`/api/documents/${docId}/collaborators/${userId}`, {
                    method: 'DELETE',
                    headers: headers
                });

                if (response.ok) {
                    showToast('Collaborator removed successfully!');
                    loadCollaborators(); // ÈáçÊñ∞Âä†ËΩΩÂçè‰ΩúËÄÖÂàóË°®
                } else {
                    const errorMsg = await response.text();
                    showToast('Failed to remove collaborator: ' + errorMsg);
                }
            } catch (err) {
                console.error('Remove collaborator error:', err);
                showToast('Failed to remove collaborator!');
            }
        }

        function colorFromId(id) {
            const colors = ['#FF6B6B', '#4ECDC4', '#45B7D1', '#96CEB4', '#FFEAA7', '#DDA0DD', '#FFA07A', '#98FB98'];
            return colors[id % colors.length];
        }

        function setupCursorTracking() {
            const container = document.getElementById('editor-container');
            const overlay = document.getElementById('cursor-overlay');

            // Track mouse movement for cursor awareness
            container.addEventListener('mousemove', (e) => {
                const rect = container.getBoundingClientRect();
                const x = (e.clientX - rect.left) / rect.width;
                const y = (e.clientY - rect.top) / rect.height;
                awareness.setLocalStateField('cursor', { x, y, t: Date.now() });
            });

            container.addEventListener('mouseleave', () => {
                awareness.setLocalStateField('cursor', null);
            });

            // Add touch event handling for mobile devices
            container.addEventListener('touchmove', (e) => {
                e.preventDefault(); // Prevent default touch behavior
                const rect = container.getBoundingClientRect();
                const touch = e.touches[0];
                const x = (touch.clientX - rect.left) / rect.width;
                const y = (touch.clientY - rect.top) / rect.height;
                awareness.setLocalStateField('cursor', { x, y, t: Date.now() });
            }, { passive: false });

            container.addEventListener('touchend', () => {
                awareness.setLocalStateField('cursor', null);
            });

            container.addEventListener('touchstart', (e) => {
                const rect = container.getBoundingClientRect();
                const touch = e.touches[0];
                const x = (touch.clientX - rect.left) / rect.width;
                const y = (touch.clientY - rect.top) / rect.height;
                awareness.setLocalStateField('cursor', { x, y, t: Date.now() });
            });

            // Render other users' cursors
            function renderCursors() {
                const rect = container.getBoundingClientRect();
                overlay.innerHTML = '';
                const states = Array.from(awareness.getStates().entries());
                
                for (const [clientId, state] of states) {
                    if (!state || clientId === awareness.clientID) continue;
                    const cursor = state.cursor;
                    if (!cursor || typeof cursor.x !== 'number' || typeof cursor.y !== 'number') continue;
                    
                    const user = state.user || { name: `User ${clientId}`, color: colorFromId(clientId) };
                    const x = cursor.x * rect.width;
                    const y = cursor.y * rect.height;

                    const cursorEl = document.createElement('div');
                    cursorEl.style.position = 'absolute';
                    cursorEl.style.left = `${x}px`;
                    cursorEl.style.top = `${y}px`;
                    cursorEl.style.transform = 'translate(-50%, -50%)';
                    cursorEl.style.pointerEvents = 'none';
                    cursorEl.style.zIndex = '1001';

                    const dot = document.createElement('div');
                    dot.style.width = '12px';
                    dot.style.height = '12px';
                    dot.style.borderRadius = '50%';
                    dot.style.background = user.color;
                    dot.style.boxShadow = '0 2px 4px rgba(0,0,0,0.3)';
                    cursorEl.appendChild(dot);

                    const label = document.createElement('div');
                    label.textContent = user.name;
                    label.style.position = 'absolute';
                    label.style.left = '15px';
                    label.style.top = '-8px';
                    label.style.fontSize = '11px';
                    label.style.padding = '2px 8px';
                    label.style.borderRadius = '12px';
                    label.style.color = '#fff';
                    label.style.background = user.color;
                    label.style.boxShadow = '0 2px 4px rgba(0,0,0,0.2)';
                    label.style.fontWeight = '500';
                    label.style.whiteSpace = 'nowrap';
                    cursorEl.appendChild(label);

                    overlay.appendChild(cursorEl);
                }
            }

            awareness.on('update', renderCursors);
            window.addEventListener('resize', renderCursors);
        }

        // Language selector
        document.getElementById('language-selector').addEventListener('change', (e) => {
            const language = e.target.value;
            monaco.editor.setModelLanguage(monacoEditor.getModel(), language);
            
            // Update user awareness with current language
            if (awareness) {
                const currentState = awareness.getLocalState();
                const user = currentState.user || {};
                user.language = language;
                awareness.setLocalStateField('user', user);
            }
        });

        // ToastÊ∂àÊÅØÊòæÁ§∫
        function showToast(message) {
            const toastContainer = document.getElementById('toast-container');
            const toast = document.createElement('div');
            toast.className = 'toast show';
            toast.innerHTML = `
                <div class="toast-body">
                    ${message}
                </div>
            `;
            toastContainer.appendChild(toast);
            
            // 3ÁßíÂêéËá™Âä®ÁßªÈô§
            setTimeout(() => {
                toast.remove();
            }, 3000);
        }

        // Keyboard shortcuts
        document.addEventListener('keydown', (e) => {
            if (e.ctrlKey || e.metaKey) {
                switch(e.key) {
                    case 's':
                        e.preventDefault();
                        document.getElementById('save-btn').click();
                        break;
                }
            }
        });

        // È°µÈù¢ÂÖ≥Èó≠ÂâçËá™Âä®‰øùÂ≠ò
        window.addEventListener('beforeunload', function(e) {
            // Ëß¶ÂèëËá™Âä®‰øùÂ≠ò‰ΩÜ‰∏çÁ≠âÂæÖÂÖ∂ÂÆåÊàêÔºå‰πü‰∏çÈòªÊ≠¢È°µÈù¢ÂÖ≥Èó≠
            autoSaveDocument();
        });

        // Ëá™Âä®‰øùÂ≠òÂáΩÊï∞
        async function autoSaveDocument() {
            // Ê£ÄÊü•Áî®Êà∑ÊòØÂê¶ÊúâÁºñËæëÊùÉÈôê
            if (!canEdit) {
                return;
            }
            
            try {
                const content = monacoEditor.getValue();
                const language = document.getElementById('language-selector').value;
                const titleElement = document.querySelector('h1 span');
                const title = titleElement ? titleElement.textContent : 'Untitled Document';
                
                // ÂØπ‰∫éÊñ∞ÊñáÊ°£ÔºàID‰∏∫'default-room'ÔºâÔºå‰∏çÊâßË°å‰ªª‰ΩïÊìç‰Ωú
                if (docId === 'default-room') {
                    return;
                }
                
                // ‰øùÂ≠òÊñáÊ°£ÂÜÖÂÆπ
                const saveResponse = await fetch('/documents/save', {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/x-www-form-urlencoded',
                        'X-CSRF-TOKEN': document.querySelector('meta[name="_csrf"]')?.getAttribute('content') || ''
                    },
                    body: new URLSearchParams({
                        documentId: docId,
                        content: content,
                        language: language,
                        title: title
                    })
                });
                
                if (saveResponse.ok) {
                    console.log('Document auto-saved successfully!');
                }
            } catch (error) {
                console.error('Auto-save error:', error);
            }
        }

        // ÂàùÂßãÂåñWebSocketÈÄöÁü•ËøûÊé•
        function connectNotificationWebSocket() {
            // ËøûÊé•Âà∞ WebSocket ÊúçÂä°Âô®
            webSocketManager.connect()
                .then(() => {
                    console.log('WebSocket connected successfully');
                    
                    // ËÆ¢ÈòÖÂÖ¨ÂÖ±ÈÄöÁü•‰∏ªÈ¢ò
                    webSocketManager.subscribe('/topic/public', function(notification) {
                        showNotification(notification);
                    });
                    
                    // ËÆ¢ÈòÖÁßÅËÅäÈÄöÁü•‰∏ªÈ¢ò
                    webSocketManager.subscribe('/user/queue/messages', function(notification) {
                        showNotification(notification);
                    });
                })
                .catch(error => {
                    console.error('Failed to connect to WebSocket:', error);
                    // Êõ¥Êñ∞ËøûÊé•Áä∂ÊÄÅÊòæÁ§∫
                    const connectionStatusEl = document.querySelector('.connection-status');
                    const connectionIndicator = document.querySelector('.connection-indicator');
                    if (connectionStatusEl) connectionStatusEl.textContent = 'disconnected';
                    if (connectionIndicator) connectionIndicator.className = 'connection-indicator disconnected';
                });
        }
        
        // ÊòæÁ§∫ÈÄöÁü•
        function showNotification(notification) {

            
            // Ê†πÊçÆ‰∏çÂêåÁ±ªÂûãÁîüÊàêÈÄöÁü•Ê†áÈ¢òÂíåÂÜÖÂÆπ
            let title = 'ÈÄöÁü•';
            let message = '';

            switch(notification.type) {
                //Ê†πÊçÆÊ∂àÊÅØÂºπÂá∫‰∏çÂêåÁöÑÊ∂àÊÅØ
                case 'task':
                    if (notification.action && notification.data.title) {
                        message = `${notification.action}‰ªªÂä° ${notification.data.title}`;
                    } else {
                        message = 'ÊÇ®Êúâ‰∏Ä‰∏™Êñ∞‰ªªÂä°';
                    }
                    // Â¢ûÂä†Êú™ËØªÈÄöÁü•ËÆ°Êï∞
                    notificationCount++;
                    updateNotificationBadge();
                    break;
                case 'comment':
                    title = 'Êñ∞ËØÑËÆ∫';
                    if (notification.action==='create'&& notification.data.content) {
                        message = `${notification.data.author}ÂèëË°®‰∫ÜÊñ∞ÁöÑÁöÑËØÑËÆ∫`;
                    } else if(notification.action==='like'&& notification.data===currentUsername)
                    {
                        message = `${notification.sender}ÁÇπËµû‰∫Ü‰Ω†ÁöÑËØÑËÆ∫`;

                    }
                    // Â¶ÇÊûú‰∏çÊòØÁÇπËµû‰Ω†ÁöÑËØÑËÆ∫Ôºå‰∏çÊòæÁ§∫ÈÄöÁü•
                    else if(notification.action==='like'&& notification.data!==currentUsername) {
                        return; // Áõ¥Êé•ËøîÂõûÔºå‰∏çÊòæÁ§∫ÈÄöÁü•
                    }
                    else {
                        message = 'ÊÇ®Êúâ‰∏ÄÊù°ËØÑËÆ∫';
                    }
                    // Â¢ûÂä†Êú™ËØªÈÄöÁü•ËÆ°Êï∞
                    notificationCount++;
                    updateNotificationBadge();
                    break;
                default:
                    // Â¢ûÂä†Êú™ËØªÈÄöÁü•ËÆ°Êï∞
                    notificationCount++;
                    updateNotificationBadge();
                    title = notification.title || 'ÈÄöÁü•';
                    message = notification.message || notification.content || 'ÊÇ®Êúâ‰∏ÄÊù°Êñ∞ÈÄöÁü•';
            }

            // ÂàõÂª∫ÈÄöÁü•È°π
            const notificationItem = document.createElement('div');
            notificationItem.className = 'notification-item unread';
            notificationItem.innerHTML = `
                <div class="notification-title">${title}</div>
                <div class="notification-message">${message}</div>
                <div class="notification-time">${new Date().toLocaleTimeString()}</div>
            `;

            // Ê∑ªÂä†ÁÇπÂáª‰∫ã‰ª∂
            notificationItem.addEventListener('click', function() {
                // Ê†áËÆ∞‰∏∫Â∑≤ËØª
                this.classList.remove('unread');
                // ÂáèÂ∞ëÊú™ËØªËÆ°Êï∞
                if (notificationCount > 0) {
                    notificationCount--;
                    updateNotificationBadge();
                }

                // Â¶ÇÊûúÈÄöÁü•ÂåÖÂê´Âä®‰ΩúÔºåÊâßË°åÁõ∏Â∫îÊìç‰Ωú
                if (notification.action) {
                    handleNotificationAction(notification);
                }
            });

            // Â∞ÜÈÄöÁü•Ê∑ªÂä†Âà∞ÂÆπÂô®È°∂ÈÉ®
            const container = document.getElementById('notifications-container');
            container.insertBefore(notificationItem, container.firstChild);
        }

        // Êõ¥Êñ∞ÈÄöÁü•ÂæΩÁ´†
        function updateNotificationBadge() {
            const badge = document.getElementById('notification-badge');
            if (notificationCount > 0) {
                badge.textContent = notificationCount;
                badge.style.display = 'flex';
            } else {
                badge.style.display = 'none';
            }
        }

        // // Â§ÑÁêÜÈÄöÁü•Âä®‰Ωú
        // function handleNotificationAction(notification) {
        //     // Ê†πÊçÆ‰∏çÂêåÁ±ªÂûãÊòæÁ§∫‰∏çÂêåÁöÑÊ∂àÊÅØÂÜÖÂÆπ
        //     let message = '';
        //     switch(notification.type) {
        //         case 'task':
        //             // ÂØπ‰∫é‰ªªÂä°Á±ªÂûãÔºåÊòæÁ§∫‰ªªÂä°Áõ∏ÂÖ≥‰ø°ÊÅØ TODO
        //             if (notification.action && notification.data.title) {
        //                 message = `Êñ∞‰ªªÂä°:${notification.action}‰ªªÂä° ${notification.data.title}`;
        //             } else {
        //                 message = 'ÊÇ®Êúâ‰∏Ä‰∏™Êñ∞‰ªªÂä°';
        //             }
        //             break;
        //         case 'comment':
        //             // ÂØπ‰∫éËØÑËÆ∫Á±ªÂûãÔºåÊòæÁ§∫ËØÑËÆ∫Áõ∏ÂÖ≥‰ø°ÊÅØ TODO
        //             if (notification.data && notification.data.content) {
        //                 message = `Êñ∞ËØÑËÆ∫: ${notification.data.content.substring(0, 30)}${notification.data.content.length > 30 ? '...' : ''}`;
        //             } else {
        //                 message = 'ÊÇ®Êúâ‰∏ÄÊù°ËØÑËÆ∫';
        //             }
        //             break;
        //         default:
        //             // ÈªòËÆ§ÊÉÖÂÜµ‰∏ãÊòæÁ§∫Ê∂àÊÅØÂÜÖÂÆπÊàñÈÄöÁî®ÊèêÁ§∫
        //             message = notification.message || notification.content || 'ÊÇ®Êúâ‰∏ÄÊù°Êñ∞ÈÄöÁü•';
        //     }
        //
        //     // ÊòæÁ§∫toastÊ∂àÊÅØ
        //     showToast(message);
        // }
        
        // Ê∏ÖÈô§ÊâÄÊúâÈÄöÁü•
        function clearNotifications() {
            const container = document.getElementById('notifications-container');
            container.innerHTML = '';
            notificationCount = 0;
            updateNotificationBadge();
        }
        
        // ÂàáÊç¢ÈÄöÁü•Èù¢ÊùøÊòæÁ§∫/ÈöêËóè
        function toggleNotificationPanel() {
            const panel = document.getElementById('notification-panel');
            panel.classList.toggle('visible');
            
            // Â¶ÇÊûúÈù¢ÊùøÊâìÂºÄÔºåÊ†áËÆ∞ÊâÄÊúâÈÄöÁü•‰∏∫Â∑≤ËØª
            if (panel.classList.contains('visible')) {
                const unreadItems = panel.querySelectorAll('.notification-item.unread');
                unreadItems.forEach(item => {
                    item.classList.remove('unread');
                });
                notificationCount = 0;
                updateNotificationBadge();
            }
        }
        
        // ÂèëÈÄÅÈÄöÁü•
        function sendNotification(notification) {
            // ÂèëÈÄÅÂà∞ÂÖ¨ÂÖ±‰∏ªÈ¢ò
            webSocketManager.sendMessage('/app/notification', notification);
        }
    </script>
    <script>
        // Á°Æ‰øùBootstrapÁªÑ‰ª∂Ê≠£Â∏∏Â∑•‰Ωú
        document.addEventListener('DOMContentLoaded', function() {
            // ÂàùÂßãÂåñ‰∏ãÊãâËèúÂçï
            var dropdownElementList = [].slice.call(document.querySelectorAll('[data-bs-toggle="dropdown"]'));
            dropdownElementList.map(function(dropdownToggleEl) {
                return new bootstrap.Dropdown(dropdownToggleEl);
            });
            
            // ÂàùÂßãÂåñÊ®°ÊÄÅÊ°Ü
            var modalElements = [].slice.call(document.querySelectorAll('.modal'));
            modalElements.map(function(modalElement) {
                // Ê£ÄÊü•Ê®°ÊÄÅÊ°ÜÊòØÂê¶Â∑≤ÁªèË¢´ÂàùÂßãÂåñ
                if (!bootstrap.Modal.getInstance(modalElement)) {
                    return new bootstrap.Modal(modalElement, {
                        backdrop: true,
                        keyboard: true
                    });
                }
            });
            
            // Á°Æ‰øùÂçè‰ΩúÊ®°ÊÄÅÊ°ÜËÉΩÊ≠£Á°ÆÂÖ≥Èó≠
            var collaborationModal = document.getElementById('collaborationModal');
            if (collaborationModal) {
                // ‰∏∫Ê®°ÊÄÅÊ°ÜÁöÑÂÖ≥Èó≠ÊåâÈíÆÊ∑ªÂä†‰∫ã‰ª∂ÁõëÂê¨Âô®
                collaborationModal.addEventListener('hidden.bs.modal', function () {
                    console.log('Collaboration modal closed');
                    // Ê∏ÖÁêÜÂèØËÉΩÁöÑÊÆãÁïôÁä∂ÊÄÅ
                    var backdrop = document.querySelector('.modal-backdrop');
                    if (backdrop) {
                        backdrop.remove();
                    }
                });
            }
            
            // Â§ÑÁêÜProfileÈìæÊé•ÁÇπÂáª‰∫ã‰ª∂Ôºà‰ªÖÂú®ÂÖÉÁ¥†Â≠òÂú®Êó∂Ê∑ªÂä†ÁõëÂê¨Âô®Ôºâ
            var profileLink = document.getElementById('profileLink');
            if (profileLink) {
                profileLink.addEventListener('click', function(e) {
                    e.preventDefault();
                    window.location.href = '/profile';
                });
            }
            
            // Â§ÑÁêÜLogoutÈìæÊé•ÁÇπÂáª‰∫ã‰ª∂Ôºà‰ªÖÂú®ÂÖÉÁ¥†Â≠òÂú®Êó∂Ê∑ªÂä†ÁõëÂê¨Âô®Ôºâ
            var logoutLink = document.getElementById('logoutLink');
            if (logoutLink) {
                logoutLink.addEventListener('click', function(e) {
                    e.preventDefault();
                    performLogout();
                });
            }
        });
        
        // ÊâßË°åÁôªÂá∫Êìç‰Ωú
        function performLogout() {
            fetch('/api/auth/logout', {
                method: 'POST',
                headers: {
                    'Content-Type': 'application/json'
                }
            })
            .then(response => {
                if (response.ok) {
                    // ÁôªÂá∫ÊàêÂäüÔºåÈáçÂÆöÂêëÂà∞ÁôªÂΩïÈ°µÈù¢
                    window.location.href = '/login?logout';
                } else {
                    console.error('Logout failed');
                    // Âç≥‰ΩøÂ§±Ë¥•‰πüÈáçÂÆöÂêëÂà∞ÁôªÂΩïÈ°µÈù¢
                    window.location.href = '/login?logout';
                }
            })
            .catch(error => {
                console.error('Logout error:', error);
                // Âç≥‰ΩøÂá∫Èîô‰πüÈáçÂÆöÂêëÂà∞ÁôªÂΩïÈ°µÈù¢
                window.location.href = '/login?logout';
            });
        }
        
    </script>
</body>
</html>